<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片资源替换测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .result { background: #f0f8ff; padding: 10px; margin: 10px 0; }
        .error { background: #ffe6e6; color: red; }
        .success { background: #e6ffe6; color: green; }
        img { max-width: 200px; margin: 10px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>图片资源URL替换测试</h1>
    
    <div class="test-section">
        <h2>测试1：模拟API图片URL</h2>
        <p>原始URL: <code>https://metaso.cn/api/file/8633750210809888768/figures?type=1&filename=1_0.jpg&sessionId=8647800048711024640</code></p>
        <p>期望替换为: <code>http://localhost:10101/api/file/8633750210809888768/figures?type=1&filename=1_0.jpg&sessionId=8647800048711024640</code></p>
        
        <div id="test1-result" class="result">
            <p>测试结果: <span id="test1-status">检测中...</span></p>
            <p>实际URL: <span id="test1-url"></span></p>
        </div>
    </div>

    <div class="test-section">
        <h2>测试2：图片加载测试</h2>
        <div>
            <img id="test-img" src="https://metaso.cn/api/file/test.jpg" alt="测试图片" 
                 onerror="handleImageError(this)" onload="handleImageLoad(this)">
        </div>
        <div id="image-status" class="result">图片加载状态: 等待中...</div>
    </div>

    <div class="test-section">
        <h2>测试3：动态图片添加测试</h2>
        <button onclick="addDynamicImage()">添加动态图片</button>
        <div id="dynamic-images"></div>
        <div id="dynamic-status" class="result">动态图片状态: 等待操作...</div>
    </div>

    <div class="test-section">
        <h2>测试4：后台URL检查</h2>
        <button onclick="testUrlReplacement()">测试URL替换</button>
        <div id="url-test-results" class="result">点击按钮开始测试...</div>
    </div>

    <script>
        // 获取当前页面的代理服务器地址
        const PROXY_SERVER_URL = window.location.origin;
        
        console.log('代理服务器地址:', PROXY_SERVER_URL);
        
        // 测试1：检查URL替换
        function checkUrlReplacement() {
            const originalUrl = 'https://metaso.cn/api/file/8633750210809888768/figures?type=1&filename=1_0.jpg&sessionId=8647800048711024640';
            const expectedUrl = `${PROXY_SERVER_URL}/api/file/8633750210809888768/figures?type=1&filename=1_0.jpg&sessionId=8647800048711024640`;
            
            // 模拟URL替换
            const replacedUrl = originalUrl.replace('https://metaso.cn', PROXY_SERVER_URL);
            
            const statusEl = document.getElementById('test1-status');
            const urlEl = document.getElementById('test1-url');
            
            if (replacedUrl === expectedUrl) {
                statusEl.textContent = '✓ 通过';
                statusEl.className = 'success';
            } else {
                statusEl.textContent = '✗ 失败';
                statusEl.className = 'error';
            }
            
            urlEl.textContent = replacedUrl;
        }

        // 图片加载处理
        function handleImageLoad(img) {
            document.getElementById('image-status').innerHTML = 
                `<span class="success">✓ 图片加载成功</span><br>实际加载URL: ${img.src}`;
        }

        function handleImageError(img) {
            document.getElementById('image-status').innerHTML = 
                `<span class="error">✗ 图片加载失败</span><br>尝试加载URL: ${img.src}`;
        }

        // 动态添加图片
        function addDynamicImage() {
            const container = document.getElementById('dynamic-images');
            const img = document.createElement('img');
            img.src = 'https://metaso.cn/api/file/dynamic-test.png';
            img.alt = '动态测试图片';
            img.style.maxWidth = '150px';
            img.onload = function() {
                document.getElementById('dynamic-status').innerHTML = 
                    `<span class="success">✓ 动态图片加载成功</span><br>URL: ${this.src}`;
            };
            img.onerror = function() {
                document.getElementById('dynamic-status').innerHTML = 
                    `<span class="error">✗ 动态图片加载失败</span><br>URL: ${this.src}`;
            };
            container.appendChild(img);
        }

        // 测试URL替换
        async function testUrlReplacement() {
            const resultsDiv = document.getElementById('url-test-results');
            resultsDiv.innerHTML = '测试中...';
            
            try {
                // 测试获取搜索页面
                const response = await fetch(`${PROXY_SERVER_URL}/search?q=图表&scope=泥沙知识`);
                const html = await response.text();
                
                // 检查是否还有未替换的metaso.cn URL
                const metasoUrls = html.match(/https:\/\/metaso\.cn[^"'\s>]*/g);
                const proxyUrls = html.match(new RegExp(`${PROXY_SERVER_URL.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}[^"'\\s>]*`, 'g'));
                
                let results = '<h4>URL替换测试结果:</h4>';
                
                if (metasoUrls && metasoUrls.length > 0) {
                    results += `<div class="error">发现 ${metasoUrls.length} 个未替换的metaso.cn URL:</div>`;
                    metasoUrls.slice(0, 5).forEach(url => {
                        results += `<div style="font-family: monospace; font-size: 12px;">${url}</div>`;
                    });
                    if (metasoUrls.length > 5) {
                        results += `<div>... 还有 ${metasoUrls.length - 5} 个</div>`;
                    }
                } else {
                    results += '<div class="success">✓ 所有metaso.cn URL都已被替换</div>';
                }
                
                if (proxyUrls && proxyUrls.length > 0) {
                    results += `<div class="success">找到 ${proxyUrls.length} 个代理服务器URL</div>`;
                    proxyUrls.slice(0, 3).forEach(url => {
                        results += `<div style="font-family: monospace; font-size: 12px;">${url}</div>`;
                    });
                }
                
                resultsDiv.innerHTML = results;
                
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">测试失败: ${error.message}</div>`;
            }
        }

        // 页面加载完成后执行测试
        window.addEventListener('load', function() {
            checkUrlReplacement();
            
            // 模拟客户端图片URL替换功能
            document.querySelectorAll('img[src*="metaso.cn"]').forEach(img => {
                const originalSrc = img.src;
                const newSrc = originalSrc.replace('https://metaso.cn', PROXY_SERVER_URL);
                if (newSrc !== originalSrc) {
                    img.src = newSrc;
                    console.log('替换图片URL:', originalSrc, '->', newSrc);
                }
            });
        });
    </script>
</body>
</html>
