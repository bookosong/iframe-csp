"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[64989],{64989:function(e,t,r){r.d(t,{Z:function(){return y}});var n=r(2403),i=r(50059),l=r(85735),o=r(5853),a=r(39207),s=r(2265),u=r(8578),d=r(2473),c=r(5194),f=r(1780),h=r(5263),p=r(89831),v=r(22322),F=r(27030),m=function(){function e(t,r){var n,i,l,o,a=this;if((0,d._)(this,e),this.totalSize=0,this.files=[],this.abortController=new AbortController,this.context=r,this.chunkUpload=null,this.totalFile=new Map,this.failQueue=[],this.limit=!1,this.rootFiberChildren=new Map,this.folderList=[],this.finishFile=0,this.uploadSize=0,this.canceled=!1,this.batchSignal=null,t instanceof u._g?(this.parentFolderId=(null===(i=t.parent)||void 0===i?void 0:null===(n=i.fileDTO)||void 0===n?void 0:n.id)||(null===(o=t.parent)||void 0===o?void 0:null===(l=o.rootFile)||void 0===l?void 0:l.id),this.totalSize=t.sizeForUpload,this.folder=t,this.currentFolderId=null,this.totalFileLength=t.childrenLength,this.initInfo(t)):(this.parentFolderId=t.folderId,this.totalSize=t.children.reduce(function(e,t){if(t instanceof u._g)a.initInfo(t);else{var r=t.abstract.file;r&&a.totalFile.set(r.webkitRelativePath||r.name,r)}return e+t.sizeForUpload},this.totalSize),this.currentFolderId=this.parentFolderId,this.rootFolder=t,this.totalFileLength=t.children.length),!this.parentFolderId)return}var t=e.prototype;return t.initInfo=function(e){var t=this;e.children&&e.children.forEach(function(e){if(e instanceof u._g)t.folderList.push(e.abstract.name),t.initInfo(e);else{var r,n=null===(r=e.abstract)||void 0===r?void 0:r.file;n&&t.totalFile.set(n.webkitRelativePath||n.name,n)}})},t.isRootUpload=function(){return!!this.rootFolder},t.uploadFinish=function(){if(this.folder){var e=this.context.getFolder(this.folder.fileDTO.id);e&&e.uploadPromiseTool.resolve(1)}},t.incrementFinishFile=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.finishFile+=e,this.context.refresh(e)},t.incrementUploadSize=function(e){this.uploadSize+=e,this.uploadSize>this.totalSize&&(this.uploadSize=this.totalSize),this.context.refreshProgress()},t.uploadByFolder=function(e,t){var r=this;return(0,n._)(function(){var n,i,l,s,u,d,c,f,h;return(0,o.Jh)(this,function(o){switch(o.label){case 0:if(n=[],!t)return[3,2];return[4,(0,a.DB7)(e,t.abstract.name,{signal:r.abortController.signal})];case 1:if((i=o.sent()).data.errCode===p.cO.PERMISSION_DENIED)throw(0,v.y)("您暂无权限上传，如需上传，请联系分享人赋予专题编辑权限",{variant:"error"}),r.currentFolderId||r.context.getFolder(r.parentFolderId).removeChildByAbstract(t.abstract.id),i.data.errMsg;return(l=r.context.getFolder(e))&&((s=l.children.find(function(e){var t;return(null===(t=e.fileDTO)||void 0===t?void 0:t.id)===i.data.data.id}))&&l.removeChildByAbstract(s),s=l.appendNewFolder(i.data.data),r.context.setFolder(i.data.data.id,s)),r.currentFolderId||(t.info.id=i.data.data.id,t.fileDTO=i.data.data,t.uploadPromiseTool=r.formRemoteTool(),r.abortController=t.uploadPromiseTool.abortController,r.context.putRef(i.data.data.id)),r.currentFolderId=i.data.data.id,n=t.children,[3,3];case 2:n=r.rootFolder.children,r.context.putRef(r.rootFolder.id),o.label=3;case 3:return r.incrementUploadSize(100),[4,r.uploadAll(n)];case 4:if(d=(u=o.sent()).form,c=u.subFolder,f=u.fileType,h=u.fileNameList,d.append("fileType",JSON.stringify(f)),!d.has("files"))return[3,6];return[4,r.uploadBatch(d,h)];case 5:o.sent(),o.label=6;case 6:return[2,c]}})})()},t.uploadAll=function(e){var t=this;return(0,n._)(function(){var r,n,i,l,a,s,d,c,f,v,F,m;return(0,o.Jh)(this,function(b){switch(b.label){case 0:r=new FormData,n=[],i={},l=[],a=0,s=!0,d=!1,c=void 0,b.label=1;case 1:b.trys.push([1,6,7,8]),f=function(){var e,s,d,c,f;return(0,o.Jh)(this,function(o){switch(o.label){case 0:if(e=F.value,t.canceled)throw"用户主动取消";if(!(e instanceof u._g))return[3,1];return n.push(e),[3,9];case 1:if(!(e.abstract.file.size>10485760||1===t.totalFileLength))return[3,7];e.uploadPromiseTool=t.formRemoteTool(),t.chunkUpload=new h.ZP(t.currentFolderId,e.abstract.file,{onProgress:function(r,n){t.isRootUpload()?e.emitEvent("progress",{progress:r}):t.incrementUploadSize(n)}}),e.chunkUploadCtr=t.chunkUpload,o.label=2;case 2:return o.trys.push([2,4,5,6]),t.isRootUpload()&&t.context.addFile(t.currentFolderId,e),[4,t.chunkUpload.oUpload()];case 3:if(0===(s=o.sent()).data.errCode&&s.data.data)null===(d=t.context.getFolder(t.currentFolderId))||void 0===d||d.appendChild(s.data.data);else throw s.data;return[3,6];case 4:if((c=o.sent())===p.cO.USER_CREDIT_RUN_OUT)throw t.limit=!0,p.cO.USER_CREDIT_RUN_OUT;return t.failQueue.push({file:e.abstract.file,name:e.abstract.file.webkitRelativePath||e.abstract.file.name,reason:c}),[3,6];case 5:return t.incrementFinishFile(),t.isRootUpload()&&(e.emitEvent("uploadFinished",{}),t.context.removeFile(t.currentFolderId,e)),t.chunkUpload=null,[7];case 6:return[3,9];case 7:if(t.rootFiberChildren.set(e.abstract.file.webkitRelativePath||e.abstract.file.name,e),r.append("files",e.abstract.file),i[f=e.abstract.file.webkitRelativePath||e.abstract.file.name]=e.abstract.type,l.push(f),!((a+=e.abstract.file.size)>=10485760||l.length>=5))return[3,9];return r.append("fileType",JSON.stringify(i)),[4,t.uploadBatch(r,l)];case 8:o.sent(),i={},a=0,r.delete("files"),r.delete("fileType"),l=[],o.label=9;case 9:return[2]}})},v=e[Symbol.iterator](),b.label=2;case 2:if(s=(F=v.next()).done)return[3,5];return[5,(0,o.XA)(f())];case 3:b.sent(),b.label=4;case 4:return s=!0,[3,2];case 5:return[3,8];case 6:return m=b.sent(),d=!0,c=m,[3,8];case 7:try{s||null==v.return||v.return()}finally{if(d)throw c}return[7];case 8:return[2,{form:r,subFolder:n,fileType:i,fileNameList:l}]}})})()},t.uploadBatch=function(e,t){var r=this;return(0,n._)(function(){var n,i,l,s,d,c,f,h,v,F,m,b,g,y,S,R,w,T,C,_,U,O,I,D,z,P,x,k,E,M,L,B,N;return(0,o.Jh)(this,function(o){switch(o.label){case 0:if(o.trys.push([0,2,3,4]),n=r.formRemoteTool(),r.isRootUpload()){i=!0,l=!1,s=void 0;try{for(d=function(){var e=f.value;e.uploadPromiseTool=n,r.context.addFile(r.currentFolderId,e),(0,u.r2)(5,15e3).begin(function(t){e.emitEvent("progress",{progress:t})})},c=r.rootFiberChildren.values()[Symbol.iterator]();!(i=(f=c.next()).done);i=!0)d()}catch(e){l=!0,s=e}finally{try{i||null==c.return||c.return()}finally{if(l)throw s}}}return[4,(0,a.sKc)(r.currentFolderId,e,{signal:r.abortController.signal})];case 1:if(0==(h=o.sent()).data.errCode){v=h.data.data,F=!0,m=!1,b=void 0;try{for(g=t[Symbol.iterator]();!(F=(y=g.next()).done);F=!0){if(R=v[S=y.value][0],w=r.totalFile.get(S),R){if(R.uploadFailMsg){if("额度已用完"===R.uploadFailMsg&&!r.limit)throw p.cO.USER_CREDIT_RUN_OUT;r.failQueue.push({file:w,name:w.webkitRelativePath||w.name,reason:R.uploadFailMsg})}else null==(C=r.rootFiberChildren.get(S))||C.emitEvent("uploadFinished",{}),null===(T=r.context.getFolder(r.currentFolderId))||void 0===T||T.appendChild(R)}else r.failQueue.push({file:w,name:w.webkitRelativePath||w.name,reason:"fileDTO返回null"});r.incrementUploadSize(w.size)}}catch(e){m=!0,b=e}finally{try{F||null==g.return||g.return()}finally{if(m)throw b}}}else throw h.data;return[3,4];case 2:if((_=o.sent())===p.cO.USER_CREDIT_RUN_OUT)throw r.limit=!0,p.cO.USER_CREDIT_RUN_OUT;U=!0,O=!1,I=void 0;try{for(D=t[Symbol.iterator]();!(U=(z=D.next()).done);U=!0)P=z.value,x=r.totalFile.get(P),r.failQueue.push({file:x,name:x.webkitRelativePath||x.name,reason:_})}catch(e){O=!0,I=e}finally{try{U||null==D.return||D.return()}finally{if(O)throw I}}return[3,4];case 3:if(r.incrementFinishFile(t.length),r.isRootUpload()){k=!0,E=!1,M=void 0;try{for(L=r.rootFiberChildren.values()[Symbol.iterator]();!(k=(B=L.next()).done);k=!0)N=B.value,r.context.removeFile(r.currentFolderId,N)}catch(e){E=!0,M=e}finally{try{k||null==L.return||L.return()}finally{if(E)throw M}}r.rootFiberChildren.clear()}return[7];case 4:return[2]}})})()},t.uploadByFolders=function(e,t){var r=this;return(0,n._)(function(){var n,i,l,a,s,u,d,c;return(0,o.Jh)(this,function(o){switch(o.label){case 0:n=!0,i=!1,l=void 0,o.label=1;case 1:o.trys.push([1,7,8,9]),a=t[Symbol.iterator](),o.label=2;case 2:if(n=(s=a.next()).done)return[3,6];return u=s.value,[4,r.uploadByFolder(e,u)];case 3:if(!((d=o.sent()).length>0))return[3,5];return[4,r.uploadByFolders(r.currentFolderId,d)];case 4:o.sent(),o.label=5;case 5:return n=!0,[3,2];case 6:return[3,9];case 7:return c=o.sent(),i=!0,l=c,[3,9];case 8:try{n||null==a.return||a.return()}finally{if(i)throw l}return[7];case 9:return[2]}})})()},t.upload=function(){var e=this;return(0,n._)(function(){var t,r;return(0,o.Jh)(this,function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),[4,e.uploadByFolder(e.parentFolderId,e.folder)];case 1:if(!((t=n.sent()).length>0))return[3,3];return[4,e.uploadByFolders(e.currentFolderId,t)];case 2:n.sent(),n.label=3;case 3:return[3,5];case 4:return n.sent(),e.incrementFinishFile(e.totalFileLength-e.finishFile),[3,5];case 5:return e.folder&&e.folder.fileDTO?(e.context.removeRef(null===(r=e.folder.fileDTO)||void 0===r?void 0:r.id),e.uploadFinish()):e.rootFolder&&e.context.removeRef(e.rootFolder.id),[2,{isRoot:e.isRootUpload(),limit:e.limit,totalSize:e.totalFileLength,folderSize:e.folderList.length,canceled:e.canceled,failMsg:e.failQueue.map(function(e){return{name:e.name,reason:e.reason}})}]}})})()},t.formRemoteTool=function(){var e=(0,F.I)(),t=new AbortController;return(0,f._)((0,c._)({},e),{resolve:function(t){e.resolve(t),"pending"===this.status&&(this.status="resolved")},reject:function(r){t.abort(r),e.reject(r),"pending"===this.status&&(this.status="rejected")},abortController:t,status:"pending"})},t.destroy=function(){if(this.canceled=!0,this.chunkUpload&&this.chunkUpload.stop(),this.abortController.abort("主动取消"),this.incrementUploadSize(this.totalSize),this.folder&&this.folder.fileDTO){var e;this.context.removeRef(null===(e=this.folder.fileDTO)||void 0===e?void 0:e.id),this.uploadFinish()}else this.rootFolder&&this.context.removeRef(this.rootFolder.id);this.folder&&this.folder.uploadPromiseTool&&(this.folder.uploadPromiseTool.reject("主动取消"),this.folder.uploadPromiseTool.status="reject")},e}(),b=r(85425),g=r(50083);function y(){var e,t=(0,i._)((0,s.useState)(new Map),2),r=t[0],d=t[1],c=(0,s.useRef)(new Map),f=(0,i._)((0,s.useState)((0,a.DOL)()),2),h=f[0],p=f[1],v=(0,s.useRef)(new Map),F=(0,s.useRef)(0),y=(0,s.useRef)(0);(0,s.useEffect)(function(){},[r,c,h]);var S=function(e,t){d(function(r){var n=r.get(e)||[],i=new Map(r);return i.set(e,[t].concat((0,l._)(n))),i}),p((0,a.DOL)())},R=(0,s.useCallback)(function(e){return r.get(e)},[r]),w=function(e,t){if(c.current.set(e,t),t.children){var r=!0,n=!1,i=void 0;try{for(var l,o=t.children[Symbol.iterator]();!(r=(l=o.next()).done);r=!0){var a=l.value;a instanceof u._g&&a.fileDTO&&a.fileDTO.id&&c.current.set(a.fileDTO.id,a)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}}},T=function(e){return c.current.get(e)},C=function(e,t){d(function(r){var n=(r.get(e)||[]).filter(function(e){return e.info.id!=t.info.id}),i=new Map(r);return i.set(e,n),i}),p((0,a.DOL)())},_=function(e){var t="string"==typeof e?e:e.fileDTO.id,r=c.current.get(t);r&&(r.stop(),r.uploadingChildrenPromiseList.forEach(function(e,t){if(e.fiber instanceof u._g){var r;_(null===(r=e.fiber.fileDTO)||void 0===r?void 0:r.id)}else e.fiber.stop()}))},U=(0,s.useCallback)(function(){var e=[];return r.forEach(function(t,r){t&&e.push.apply(e,(0,l._)(t))}),e},[r]),O=(0,s.useCallback)(function(e){var t=v.current.get(e);t&&t.length>0&&t.forEach(function(e){e.destroy()})},[]),I=(0,s.useCallback)(function(e){y.current+=e,x({})},[]),D=(0,s.useCallback)(function(e){var t,r=v.current.get(e),n=0,i=0;r&&(r.forEach(function(e){n+=e.totalSize,i+=e.uploadSize}),null===(t=T(e))||void 0===t||t.emitUploadProgress((i/n*100).toFixed(2)))},[]),z=(0,i._)((0,s.useState)({}),2),P=z[0],x=z[1],k=(0,s.useMemo)(function(){return{total:F.current,finish:y.current}},[P]),E=(0,s.useCallback)((e=(0,n._)(function(e,t){var r,n,i,s,d,c,f,h,p,b,g,R,_,U,O,z,P;return(0,o.Jh)(this,function(k){switch(k.label){case 0:0===v.current.size&&(F.current=0,y.current=0,x({})),r=[],i={isRoot:(n={id:(0,a.DOL)(),folderId:e,children:[],temp:!0}).children.length>0,totalSize:0,folderSize:0,failMsg:[],canceled:!1},s=0,d=!0,c=!1,f=void 0;try{for(h=t[Symbol.iterator]();!(d=(p=h.next()).done);d=!0)(b=p.value)instanceof u._g?(r.push(b),s+=b.childrenLength):(n.children.push(b),s++)}catch(e){c=!0,f=e}finally{try{d||null==h.return||h.return()}finally{if(c)throw f}}F.current+=s,x({}),n.children.length>0&&r.push(n),g=!0,R=!1,_=void 0,k.label=1;case 1:k.trys.push([1,6,7,8]),U=function(){var e,t,r,n,a;return(0,o.Jh)(this,function(o){switch(o.label){case 0:return e=z.value,r=null,[4,(n=new m(e,{getFolder:T,setFolder:w,putRef:function(e){r=e;var t,i=v.current.get(e);i||(i=[]),i.push(n),v.current.set(e,i),1===i.length&&(null===(t=T(e))||void 0===t||t.emitUploadProgress(0))},removeRef:function(e){var t,r,i=(null===(t=v.current.get(e))||void 0===t?void 0:t.filter(function(e){return e!==n}))||[];0===i.length?v.current.delete(e):v.current.set(e,i),null===(r=T(e))||void 0===r||r.emitUploadProgress(100)},addFile:S,removeFile:C,refresh:function(e){I(e)},refreshProgress:function(){D(r)}})).upload()];case 1:return a=o.sent(),i.folderSize+=a.folderSize,i.totalSize+=a.totalSize,(t=i.failMsg).push.apply(t,(0,l._)(a.failMsg)),i.limit=a.limit,i.canceled=a.canceled,[2]}})},O=r[Symbol.iterator](),k.label=2;case 2:if(g=(z=O.next()).done)return[3,5];return[5,(0,o.XA)(U())];case 3:k.sent(),k.label=4;case 4:return g=!0,[3,2];case 5:return[3,8];case 6:return P=k.sent(),R=!0,_=P,[3,8];case 7:try{g||null==O.return||O.return()}finally{if(R)throw _}return[7];case 8:return i.totalSize,[2,i]}})}),function(t,r){return e.apply(this,arguments)}),[]),M=(0,s.useRef)(""),L=(0,s.useRef)(null),B=(0,s.useRef)(null),N=(0,i._)((0,s.useState)(null),2),A=N[0];N[1];var J=b.H.useAPI("managerAPI"),Q=(0,s.useCallback)(function(e,t){M.current=e,L.current&&(clearTimeout(L.current),B.current&&B.current.abort()),e&&function e(r){var n=[],i=new Map,l=!0,o=!1,s=void 0;try{for(var u,d=t.values()[Symbol.iterator]();!(l=(u=d.next()).done);l=!0){var c=u.value;c.fileDTO&&(c.fileDTO.folder&&c.dealProgress<100||c.fileDTO.progress>=0&&c.fileDTO.progress<100)&&(n.push(c.fileDTO.id),i.set(c.fileDTO.id,c))}}catch(e){o=!0,s=e}finally{try{l||null==d.return||d.return()}finally{if(o)throw s}}0!==n.length&&(B.current=new AbortController,(0,a.SFo)(n,{single:B.current.single}).then(function(e){if(0===e.data.errCode&&e.data.data){var t=e.data.data;n.forEach(function(e){var r,n,l=i.get(e);if(!v.current.has(e)){var o=t[e];o>=l.dealProgress?l.setDealProgress(o):o<0&&((0,g.i)("".concat(l.name,"处理失败")),null===(r=J.current)||void 0===r||r.removeFiles([e]),null===(n=l.parent)||void 0===n||n.removeChildByFile(e)),l.fileDTO.progress=o}})}else 404===e.data.errCode&&((0,g.i)("".concat(n.length,"个文件处理失败")),n.forEach(function(e){var t,r,n=i.get(e);null===(t=J.current)||void 0===t||t.removeFiles([e]),null===(r=n.parent)||void 0===r||r.removeChildByFile(e)}))}).finally(function(){M.current===r&&(L.current=setTimeout(function(){e(r)},1500))}))}(e)},[]);return(0,s.useEffect)(function(){},[A]),(0,s.useMemo)(function(){return{add:S,get:R,remove:C,setFolder:w,getFolder:T,clearFolder:_,getAll:U,key:h,uploadFiles:E,dealBatchProgress:Q,stopUploadFolder:O,uploadStatus:k}},[h,r,k])}},85425:function(e,t,r){r.d(t,{H:function(){return i}});var n=r(14382),i=r.n(n)()()()}}]);