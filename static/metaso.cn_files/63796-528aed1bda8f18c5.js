"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[63796],{16712:function(e,t,n){n.d(t,{g:function(){return h}});var i=n(2473),s=n(5194),r=n(1780),a={WORD:"word",CHINESE_WORD:"chinese_word",NUMBER:"number",PUNCTUATION:"punctuation",SEPARATOR:"separator",PROTECTED:"protected"},h=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i._)(this,e),this.languageThresholds={cn:{shortSentence:10,briefContent:5},en:{shortSentence:5,briefContent:3},mixed:{shortSentence:8,briefContent:4}},this.abbreviations=new Set(["mr","mrs","ms","dr","prof","sr","jr","vs","etc","inc","ltd","corp","co","dept","govt","assn","bros","ph","md","ba","ma","phd","llb","rev","hon","gen","col","maj","capt","lt","sgt","pvt","ave","st","rd","blvd","apt","bldg","fl","rm","ste","jan","feb","mar","apr","jun","jul","aug","sep","oct","nov","dec","mon","tue","wed","thu","fri","sat","sun","am","pm","ad","bc","ie","eg","cf","al","no","u.s","u.k","u.n","llc","u.s.a"]),this.compiledPatterns={numberPatterns:[/\b(section|chapter|part|volume|page|figure|table|appendix|article|clause|paragraph)\s+\d+(\.\d+)*\b/gi,/\b(version|ver|v)\s*\d+(\.\d+)*\b/gi,/\b\d+(\.\d+)*\s*(st|nd|rd|th)\b/gi],url:/https?:\/\/[^\s]+|www\.[^\s]+/g,email:/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,optionList:/([A-J]|\d+)\.\s*([^.!?]*?)(?=\s*([A-J]|\d+)\.\s*|\s*$|[.!?])/g,decimal:/\d+\.\d+/g,listIndicator:/:[\s]*$|options?[\s]*:?[\s]*$|choose[\s]*:?[\s]*$|select[\s]*:?[\s]*$/i},this.charSets={splitChars:new Set("。!！?？；.……\n".split("")),quoteChars:new Set(['"',"“","”","(",")"]),digits:/\d/,englishLetter:/[A-Za-z]/,chineseChar:/[\u4e00-\u9fa5]/,wordChar:/[A-Za-z']/,nonWord:/[^\w]/,whitespace:/\s/},this.text="",this.currentIndex=0,this.lastToken=null,this.sentences=[],this.tempSentence="",this.currentSpeaker="",this.protectedRanges=[],this.itemMode=!1,this.options=(0,s._)({preserveWhitespace:!1,trimSentences:!0,preserveOptions:!0,preserveAbbreviations:!0,preserveNumbers:!0,talkMode:!1,language:"mixed",firstSentenceNotMergeNext:!1},t)}var t=e.prototype;return t.countTokens=function(e){if(!e.trim())return 0;for(var t=0,n=0;n<e.length;){var i=e[n];if(this.charSets.whitespace.test(i)){n++;continue}if(this.charSets.chineseChar.test(i))t++,n++;else if(this.charSets.englishLetter.test(i)){for(;n<e.length&&this.charSets.wordChar.test(e[n]);)n++;t++}else if(this.charSets.digits.test(i)){for(;n<e.length&&(this.charSets.digits.test(e[n])||"."===e[n]);)n++;t++}else t++,n++}return t},t.getThresholds=function(){return this.languageThresholds[this.options.language]||this.languageThresholds.mixed},t.preprocessText=function(e){this.protectedRanges=[],this.options.preserveOptions&&this.findOptionLists(e),this.options.preserveAbbreviations&&this.findAbbreviations(e),this.options.preserveNumbers&&this.findNumbers(e),this.findUrlsAndEmails(e),this.findNumberPatterns(e),this.protectedRanges.sort(function(e,t){return e.start-t.start})},t.findOptionLists=function(e){var t,n,i=this;for(this.compiledPatterns.optionList.lastIndex=0;null!==(t=this.compiledPatterns.optionList.exec(e));)n=this,function(){var s=t.index,r=e.substring(Math.max(0,s-50),s);if(n.compiledPatterns.listIndicator.test(r)||r.match(/\.\s*$/)){var a=n.findOptionSequenceEnd(e,s),h=n.text.substring(s,a).split("\n"),d=s;h.forEach(function(t){t.split(" ").forEach(function(t,n){var s=d+t.length;if(!i.isRangeOverlapping(d,s)){var r={start:d,end:s,type:"optionListItem",originalText:e.substring(d,s)};i.protectedRanges.push(r)}d+=t.length+1})})}}()},t.findOptionSequenceEnd=function(e,t){var n=t,i=t,s=e.substring(n).match(/^([A-J]|\d+)\.\s.*?(?=\s+([A-J]|\d+)\.\s+|\n|[.!?]\s|$)/);for(s&&(n=i=n+s[0].length);n<e.length;){for(;n<e.length&&this.charSets.whitespace.test(e[n])||/[.!?]/.test(e[n]);)n++;var r=e.substring(n).match(/^([A-J]|\d+)\.\s.*?(?=\s+([A-J]|\d+)\.\s+|\n|[.!?]\s|$)/);if(r)n=i=n+r[0].length;else break}return i},t.findAbbreviations=function(e){var t=!0,n=!1,i=void 0;try{for(var s,r=this.abbreviations[Symbol.iterator]();!(t=(s=r.next()).done);t=!0)for(var a=s.value.replace(/\./g,"\\."),h=RegExp("\\b".concat(a,"\\.?(?=\\s|$)"),"gi"),d=void 0;null!==(d=h.exec(e));){var u=d.index,c=u+d[0].length;this.isRangeOverlapping(u,c)||this.protectedRanges.push({start:u,end:c,type:"abbreviation",originalText:d[0]})}}catch(e){n=!0,i=e}finally{try{t||null==r.return||r.return()}finally{if(n)throw i}}},t.findNumbers=function(e){var t;for(this.compiledPatterns.decimal.lastIndex=0;null!==(t=this.compiledPatterns.decimal.exec(e));){var n=t.index,i=n+t[0].length;this.isRangeOverlapping(n,i)||this.protectedRanges.push({start:n,end:i,type:"number",originalText:t[0]})}},t.findUrlsAndEmails=function(e){this.findPatternMatches(e,this.compiledPatterns.url,"url"),this.findPatternMatches(e,this.compiledPatterns.email,"email")},t.findNumberPatterns=function(e){var t=this;this.compiledPatterns.numberPatterns.forEach(function(n){t.findPatternMatches(e,n,"numberPattern")})},t.findPatternMatches=function(e,t,n){var i;for(t.lastIndex=0;null!==(i=t.exec(e));)this.isRangeOverlapping(i.index,i.index+i[0].length)||this.protectedRanges.push({start:i.index,end:i.index+i[0].length,type:n,originalText:i[0]})},t.isRangeOverlapping=function(e,t){return this.protectedRanges.some(function(n){return e>=n.start&&e<n.end||t>n.start&&t<=n.end||e<=n.start&&t>=n.end})},t.isProtected=function(e){return this.protectedRanges.some(function(t){return e>=t.start&&e<t.end})},t.getNextToken=function(){if(this.currentIndex>=this.text.length)return null;var e=this.text[this.currentIndex];return this.isProtected(this.currentIndex)?this.readProtectedToken():this.charSets.digits.test(e)?(this.itemMode=!1,this.readNumber()):this.charSets.englishLetter.test(e)?(this.itemMode=!1,this.readWord()):this.charSets.chineseChar.test(e)?(this.itemMode=!1,this.readChineseWord()):this.charSets.splitChars.has(e)?this.shouldTreatAsNormalPunctuation(e)?(this.currentIndex++,{type:a.PUNCTUATION,value:e}):(this.itemMode=!1,this.currentIndex++,{type:a.SEPARATOR,value:e}):this.charSets.nonWord.test(e)?(this.currentIndex++,{type:a.PUNCTUATION,value:e}):(this.currentIndex++,{type:a.WORD,value:e})},t.isOptionStart=function(e){if(/[A-J]/.test(e)){var t=this.text[this.currentIndex+1];return t&&"."===t&&this.currentIndex+2<this.text.length&&!this.charSets.whitespace.test(this.text[this.currentIndex+2])&&(null===this.lastToken||this.lastToken.type!==a.WORD)&&(this.itemMode||"A"===e)}if(this.charSets.digits.test(e)){for(var n=this.currentIndex,i="";n<this.text.length&&this.charSets.digits.test(this.text[n]);)i+=this.text[n],n++;var s=n<this.text.length&&"."===this.text[n]&&n+1<this.text.length&&!this.charSets.whitespace.test(this.text[n+1]),r=0===this.currentIndex||"\n"===this.text[this.currentIndex-1]||this.charSets.whitespace.test(this.text[this.currentIndex-1]);return s&&r&&(null===this.lastToken||this.lastToken.type!==a.WORD||this.itemMode||"1"===i)}return!1},t.shouldTreatAsNormalPunctuation=function(e){return"."===e&&this.currentIndex+1<this.text.length&&!this.charSets.whitespace.test(this.text[this.currentIndex+1])&&'"'!==this.text[this.currentIndex+1]},t.readProtectedToken=function(){var e=this,t=this.protectedRanges.find(function(t){return e.currentIndex>=t.start&&e.currentIndex<t.end});if(t){var n=this.text.substring(t.start,t.end);return this.currentIndex=t.end,{type:a.PROTECTED,value:n,protectedType:t.type}}var i=this.text[this.currentIndex];return this.currentIndex++,{type:a.WORD,value:i}},t.readNumber=function(){for(var e="",t=!1;this.currentIndex<this.text.length;){var n=this.text[this.currentIndex];if(this.charSets.digits.test(n))e+=n,this.currentIndex++;else if("."===n&&!t&&this.currentIndex+1<this.text.length&&this.charSets.digits.test(this.text[this.currentIndex+1]))t=!0,e+=n,this.currentIndex++;else break}return{type:a.NUMBER,value:e}},t.readWord=function(){for(var e="";this.currentIndex<this.text.length&&this.charSets.wordChar.test(this.text[this.currentIndex]);)e+=this.text[this.currentIndex],this.currentIndex++;return{type:a.WORD,value:e}},t.readChineseWord=function(){for(var e="";this.currentIndex<this.text.length&&this.charSets.chineseChar.test(this.text[this.currentIndex]);)e+=this.text[this.currentIndex],this.currentIndex++;return{type:a.CHINESE_WORD,value:e}},t.isNextOptionStart=function(){if(this.currentIndex>=this.text.length)return!1;this.text[this.currentIndex];for(var e=this.currentIndex;e<this.text.length&&this.charSets.whitespace.test(this.text[e]);)e++;if(e>=this.text.length)return!1;var t=this.text[e];if(/[A-J]/.test(t)&&e+1<this.text.length&&"."===this.text[e+1])return!0;if(this.charSets.digits.test(t)){for(var n=e;n<this.text.length&&this.charSets.digits.test(this.text[n]);)n++;if(n<this.text.length&&"."===this.text[n])return!0}return!1},t.addSentence=function(e,t){var n=this.getThresholds(),i=this.countTokens(this.tempSentence),s=this.countTokens(e.trim());if(0===this.sentences.length&&this.options.firstSentenceNotMergeNext&&s>=n.shortSentence){this.sentences.push({speaker:t,text:e});return}if((i<=n.shortSentence||s<=n.briefContent)&&this.currentSpeaker===t){var r=this.shouldUseChinesesStyle(e);this.tempSentence+=r||"."===e.trim()?e.trim():" ".concat(e.trim())}else this.tempSentence.trim().length>0&&this.sentences.push({speaker:t,text:this.tempSentence.trim()}),this.tempSentence=e.trim()},t.shouldUseChinesesStyle=function(e){return"cn"===this.options.language||"mixed"===this.options.language&&this.charSets.chineseChar.test(e)},t.parseSentence=function(){for(var e="",t=!1,n=this.currentSpeaker;;){var i=this.getNextToken();if(!i)break;n=this.currentSpeaker;var s=!1;this.charSets.quoteChars.has(i.value)&&(t&&("”"===i.value||'"'===i.value||")"===i.value)?(t=!1,this.lastToken&&this.lastToken.type===a.SEPARATOR&&(s=!0)):t=!0),e+=i.value,i.type!==a.SEPARATOR&&!s||t||(e=this.processSpeakerTag(e),"."===i.value&&this.shouldUseChinesesStyle(e)||(this.addSentence(e,n),e="")),this.lastToken=i}this.finalizeSentence(e,this.currentSpeaker)},t.processSpeakerTag=function(e){if(!this.options.talkMode)return e;var t=e.trim().match(/^\[(.*?)\]/);return t?(this.currentSpeaker=t[1],e.replace("[".concat(t[1],"]"),"")):e},t.finalizeSentence=function(e,t){e=this.processSpeakerTag(e);var n=this.getThresholds(),i=this.countTokens(this.tempSentence),s=this.countTokens(e.trim());if((i<=n.shortSentence||s<=n.briefContent)&&t===this.currentSpeaker){var r=this.shouldUseChinesesStyle(e);this.tempSentence+=r||"."===e.trim()?e.trim():" ".concat(e.trim()),this.tempSentence.trim().length>0&&this.sentences.push({speaker:this.currentSpeaker,text:this.tempSentence.trim()})}else this.tempSentence.trim().length>0&&this.sentences.push({speaker:t,text:this.tempSentence.trim()}),e.trim().length>0&&this.sentences.push({speaker:this.currentSpeaker,text:e.trim()})},t.setText=function(e){this.text=e,this.tempSentence="",this.currentIndex=0,this.currentSpeaker="",this.itemMode=!1,this.lastToken=null,this.processText()},t.processText=function(){this.sentences=[],this.preprocessText(this.text),this.parseSentence()},t.getSplitSentences=function(){return this.sentences},t.splitSentences=function(e){return this.setText(e),this.sentences.map(function(e){return e.text})},t.analyze=function(e){this.setText(e);var t=this.sentences.map(function(e){return e.text}),n=t.reduce(function(e,t){var n=t.trim();return n.endsWith("?")||n.endsWith("？")?e.questionSentences++:n.endsWith("!")||n.endsWith("！")?e.exclamationSentences++:e.statementSentences++,e},{questionSentences:0,exclamationSentences:0,statementSentences:0}),i=t.flatMap(function(e){var t=e.match(/([A-J]|\d+)\..*?(?=\s+([A-J]|\d+)\.\s*|\n|[.!?]\s|$)/g);return t?t.map(function(e){return e.trim()}):[]}),a=this.protectedRanges.map(function(e){return{type:e.type,text:e.originalText}});return(0,r._)((0,s._)({sentences:t,totalSentences:t.length},n),{optionsDetected:i,protectedElements:a})},e.splitEnglish=function(t){return new e({language:"en",preserveAbbreviations:!0,preserveNumbers:!0,preserveOptions:!0}).splitSentences(t)},e.splitChinese=function(t){return new e({language:"cn",preserveNumbers:!0,preserveOptions:!0}).splitSentences(t)},e.splitMixed=function(t){return new e({language:"mixed",preserveAbbreviations:!0,preserveNumbers:!0,preserveOptions:!0}).splitSentences(t)},e.splitWithSpeakers=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"mixed",i=new e({talkMode:!0,language:n,preserveAbbreviations:!0,preserveNumbers:!0,preserveOptions:!0});return i.setText(t),i.getSplitSentences()},e}()},70877:function(e,t,n){n.d(t,{Z:function(){return p}});var i=n(2403),s=n(2473),r=n(5853),a=function(){function e(t){(0,s._)(this,e),this.sentences=[],this.sentenceNum=0,this.lastSentenceIndex=0,this.map=new Map,this.pageIndex=t.pageIndex,this.pageId=t.pageId}var t=e.prototype;return t.addChunk=function(e){var t=e.sentenceId;this.map.set(t,e)},t.resetIndex=function(){},t.addSentence=function(e,t){if(e.text.trim()){var n=this.sentences.length;this.sentences.push({text:e,sent:!1,index:n,finished:t})}},t.getIndex=function(){return this.pageIndex},t.getId=function(){return this.pageId},t.getSentences=function(){return this.sentences},t.getSendSentence=function(e){return this.sentences[e]},t.getSentencesLength=function(){return this.sentences.length},t.getBuffer=function(e){var t=this.map.get(e);try{return new Uint8Array(t.data.match(/.{1,2}/g).map(function(e){return parseInt(e,16)}))}catch(e){return null}},t.getChunk=function(e){return this.map.get(e)},t.setLastSentenceIndex=function(e){this.lastSentenceIndex=e},t.getLastSentenceIndex=function(){return this.lastSentenceIndex},e}(),h=n(39207),d=n(22322),u=n(23760),c=n(7870),o=n(27030),l=new Map,p=function(){function e(t){var n,i=this;(0,s._)(this,e),this.ws=null,this.currentTaskId=null,this.systemMessageIndex=0,this.scene=void 0,this.closed=!0,this.onSentenceChange=null,this._onTimeupdate=null,this.volume=.5,this.speed=1,this.isPaused=!0,this.mediaSource=null,this.sourceBuffer=null,this.audioQueue=[],this.mute=!1,this.checkConnectionTimeout=null,this.chapterId="",this.isProcessing=!1,this.lastPageIndex=0,this.currentPageIndex=0,this.pageIndexMap=new Map,this._isConnected=!1,this.isBegin=!1,this.retryCount=0,this.isReconnecting=!1,this.heartbeatInterval=null,this.isSystem=!1,this.lastPausedTime=0,this.currentSentenceId=0,this.waitSystemSound=!1,this.needWelcome=!1,this.playTime=0,this.playTimeInterval=null,this.disConnectTime=0,this.uuid="",this.isFirstConnect=!0,this.sentenceOverTimeout=null,this.sexMap=new Map,this.currentVoiceId="(Mandarin)_Radio_Host",this.firstVoiceId="(Mandarin)_Radio_Host",this.waitDataTimeout=null,this.startLoadDataTime=0,this.sendTextInterval=null,this.uuid=(0,h.DOL)(),l.set(this.uuid,this),this.onSentenceChange=t.onSentenceChange,this.chapterId=t.chapterId,this.onClosed=t.onClosed,t.taskIdSuffix&&(this.isSystem=!0),this.scene=t.scene,this.currentTaskId=t.chapterId+(t.taskIdSuffix?"-".concat(t.taskIdSuffix):""),this._onTimeupdate=t.onTimeupdate,this.ttsTimber=t.ttsTimber,"暴躁"===t.scene&&(this.ttsTimber="Chinese (Mandarin)_Unrestrained_Young_Man"),this.onConnected=t.onConnected,this.onPaused=t.onPaused,this.volume=null!==(n=t.volume)&&void 0!==n?n:.5,this.speed=t.speed||1,this.audioPlayer=document.createElement("audio"),this.audioPlayer.style.display="none",this.audioPlayer.volume=this.volume,this.audioPlayer.playbackRate=this.speed,this.systemAudioPlayer=document.createElement("audio"),this.systemAudioPlayer.style.display="none",this.systemAudioPlayer.volume=this.volume,this.needWelcome=!!t.needWelcome,this.pptId=t.pptId||"",this.initMediaSource(),this.sexMap.set("男",!0),this.playTimeInterval=setInterval(function(){i.isPaused||(i.playTime+=100),!i.isSystem&&i.playTime>5e3&&((0,h.hFz)(Math.ceil(i.playTime/1e3)),i.playTime=0)},100)}var t=e.prototype;return t.onTimeupdate=function(){if(clearTimeout(this.sentenceOverTimeout),!this.isPaused&&this.audioPlayer&&0!==this.audioPlayer.currentTime){var e,t=this.pageIndexMap.get(this.currentPageIndex);this._onTimeupdate(t.getIndex(),this.audioPlayer.currentTime);var n=t.getSendSentence(this.currentSentenceId).text,i=(null===(e=t.getChunk(this.currentSentenceId))||void 0===e?void 0:e.sentence)||n.text;"男女对话"===this.scene&&n.speaker&&(i=(this.sexMap.get(n.speaker)?"男：":"女：")+i),this.onSentenceChange(i)}},t.getAllSentence=function(){return this.pageIndexMap.values().map(function(e){return{pageIndex:e.getIndex(),sentences:e.getSentences()}})},t.getNextPosition=function(){var e=this.pageIndexMap.get(this.currentPageIndex);return e.getSendSentence(this.currentSentenceId).finished?e.getIndex()+1<this.pageIndexMap.size?{pageIndex:this.currentPageIndex+1,sentenceIndex:0}:{pageIndex:0,sentenceIndex:0}:{pageIndex:this.currentPageIndex,sentenceIndex:this.currentSentenceId+1}},t.initMediaSource=function(){var e=this;this.audioPlayer.ontimeupdate=function(){e.onTimeupdate()},this.audioPlayer.onended=function(){var t=!e.isPaused,n=e.pageIndexMap.get(e.currentPageIndex);if(e.audioPlayer.currentTime>0&&!n.getSendSentence(e.currentSentenceId).finished)e.currentSentenceId++;else if(e.audioPlayer.currentTime>0){n.setLastSentenceIndex(0),window.postMessage({type:"tts-page-finished",page:n.getIndex(),totalPage:e.pageIndexMap.size});var i=n.getIndex()+1;e._onTimeupdate(i,e.audioPlayer.currentTime),i<e.pageIndexMap.size?(e.gotoPage(i),e.currentSentenceId=0):(e.isPaused=!0,t=!1)}t&&e.continue(!0)}},t.isConnected=function(){return this.isBegin},t.connectWebSocket=function(){var e=this,t=new URL("https://metaso.cn",location.origin);this.ws=new WebSocket("".concat("wss","://").concat(t.host,"/api/ppt/ws?chapterId=").concat(this.chapterId,"&t=").concat(Math.random()));var n=this;this.ws.onopen=(0,i._)(function(){return(0,r.Jh)(this,function(e){return n._isConnected=!0,n.retryCount=0,n.sendStartMessage(),n.isFirstConnect&&(n.isFirstConnect=!1,n.onConnected()),n.heartbeatInterval=setInterval(function(){var e;null===(e=n.ws)||void 0===e||e.send(JSON.stringify({action:"heartbeat"}))},5e3),[2]})}),this.ws.onmessage=function(t){var n,i=JSON.parse(t.data);void 0!==i.audio&&(null===(n=e.pageIndexMap.get(i.pageIndex))||void 0===n||n.addChunk({data:i.audio,sentenceId:i.sentenceId,chunkId:i.chunkId,pageId:i.pageId,sentence:i.sentenceText,duration:i.duration}),i.errorMsg)},this.ws.onerror=function(e){},this.ws.onclose=function(t){e.isReconnecting=!1,1e3!==t.code&&(e.isBegin&&(e.isBegin=!1,e.pageIndexMap.forEach(function(e){e.getSentences().forEach(function(t){0===e.getIndex()&&0===t.index||(t.sent=!1)})})),e.disConnectTime=new Date().getTime(),0===e.retryCount&&setTimeout(function(){e.reconnect()},1e3)),e._isConnected=!1,e.closed=!0,e.ws=null}},t.reconnect=function(){var e,t=this;!this.isReconnecting&&(this.isReconnecting=!0,!(this.retryCount>=20)&&(this.retryCount+=1,this.closed=!1,(null===(e=this.currentTaskId)||void 0===e?void 0:e.endsWith("-qa"))||this.isPaused||(0,d.y)("重连中...",{variant:"warning",autoHideDuration:3e3}),this._isConnected||(this.start(),setTimeout(function(){if(t._isConnected){var e;(null===(e=t.currentTaskId)||void 0===e?void 0:e.endsWith("-qa"))||t.isPaused||(0,d.y)("重连成功",{variant:"success",autoHideDuration:3e3}),t.gotoPage(t.currentPageIndex,!0),!t.isPaused&&new Date().getTime()-t.disConnectTime<12e5&&(t.checkLoading()||t.audioPlayer.ended)&&t.continue(!0)}else t.isReconnecting=!1,t.reconnect()},1e4))))},t.addPage=function(e,t){if(!this.pageIndexMap.has(t)){var n=new a({pageId:e,pageIndex:t});0===t&&this.needWelcome&&(n.addSentence({text:"欢迎XXX进入秘塔AI讲解",speaker:""}),n.getSendSentence(0).sent=!0),this.pageIndexMap.set(t,n)}},t.addPageText=function(e,t,n){var i;null===(i=this.pageIndexMap.get(e))||void 0===i||i.addSentence(t,n)},t.start=function(){var e=this;return(0,i._)(function(){return(0,r.Jh)(this,function(t){return e.closed=!1,e.ws&&e.ws.readyState===WebSocket.OPEN||e.connectWebSocket(),[2]})})()},t.sendStartMessage=function(){var e=this;return(0,i._)(function(){var t,n;return(0,r.Jh)(this,function(i){return n={taskId:e.currentTaskId,action:"begin"},(null===(t=e.ws)||void 0===t?void 0:t.readyState)===WebSocket.OPEN&&(e.ws.send(JSON.stringify(n)),e.isBegin=!0),[2]})})()},t.send=function(e,t,n,i){if(!this.ws||!this.currentTaskId&&!this._isConnected){this._isConnected=!1;return}if(n.text.trim()){"男女对话"!==this.scene||(this.sexMap.get(n.speaker)?this.currentVoiceId="Chinese (Mandarin)_Radio_Host":this.currentVoiceId="uk_woman16",this.firstVoiceId||(this.firstVoiceId=this.currentVoiceId));var s={taskId:this.currentTaskId,action:"normal",allowCache:!0,pageId:e,pageIndex:t,sentenceId:i,text:n.text.trim(),tts_args:{voice_id:"男女对话"===this.scene?this.currentVoiceId:this.ttsTimber&&"null"!==this.ttsTimber?this.ttsTimber:"male-qn-daxuesheng",emotion:"暴躁"===this.scene?"angry":void 0,vol:"女"===n.speaker?.9:1}};this.ws.send(JSON.stringify(s))}},t.pause=function(){var e,t;this.lastPageIndex=this.currentPageIndex,null===(e=this.pageIndexMap.get(this.lastPageIndex))||void 0===e||e.setLastSentenceIndex(this.currentSentenceId),this.isPaused=!0,this.audioPlayer.pause(),null===(t=this.onPaused)||void 0===t||t.call(this)},t.continue=function(e){var t=this;l.forEach(function(e){e.uuid!==t.uuid&&e.pause()}),this.isPaused=!1,e?(this.loadData(this.currentPageIndex,this.currentSentenceId,this.lastPausedTime),this.lastPausedTime=0):this.pageIndexMap.has(this.currentPageIndex)&&(this.audioPlayer.playbackRate=this.speed,this.mute?this.audioPlayer.volume=0:this.audioPlayer.volume=this.volume,this.audioPlayer.play())},t.close=function(){var e,t,n,i,s,r,a=(0,o.I)();return this.ws?this.ws.readyState===this.ws.CLOSED?a.resolve():null===(r=this.ws)||void 0===r||r.addEventListener("close",function(){a.resolve()}):a.resolve(),l.delete(this.uuid),null===(e=this.ws)||void 0===e||e.close(1e3),this.ws=null,clearInterval(this.heartbeatInterval),clearInterval(this.sendTextInterval),null===(t=this.audioPlayer)||void 0===t||t.pause(),null===(n=this.audioPlayer)||void 0===n||n.remove(),null===(i=this.systemAudioPlayer)||void 0===i||i.pause(),null===(s=this.systemAudioPlayer)||void 0===s||s.remove(),this.audioPlayer=null,this.pageIndexMap=null,clearInterval(this.playTimeInterval),this.isSystem||(0,h.hFz)(Math.ceil(this.playTime/1e3)),this.pptId&&u.LM.getState().login&&(0,h.fpm)(this.pptId,this.currentPageIndex,this.currentSentenceId),a.done},t.sendSystemMessage=function(e,t,n){var i=this,s={action:"normal",text:e,tts_args:{voice_id:this.ttsTimber&&"null"!==this.ttsTimber?this.ttsTimber:"male-qn-daxuesheng",emotion:"暴躁"===this.scene?"angry":void 0}};(0,h.jQW)(s).then(function(e){if(0===e.data.errCode){var s,r=e.data.data,a=r.duration;i.isPaused?t&&t():(i.pause(),setTimeout(function(){i.continue(!1)},(a+.1)*1e3)),n&&!i.closed?null===(s=i.pageIndexMap.get(0))||void 0===s||s.addChunk({data:r.audio,sentenceId:r.sentenceId,chunkId:r.chunkId,pageId:r.pageId,sentence:r.sentenceText,duration:r.duration}):(i.lastPausedTime=i.audioPlayer.currentTime,i.systemAudioPlayer.src=URL.createObjectURL(new Blob([new Uint8Array(r.audio.match(/.{1,2}/g).map(function(e){return parseInt(e,16)}))],{type:"audio/mp3"})),i.systemAudioPlayer.playbackRate=i.speed,i.systemAudioPlayer.play())}}).catch(function(s){setTimeout(function(){i.closed||i.sendSystemMessage(e,t,n)},1e3)})},t.waitData=function(e,t,n){var i,s,r=this,a=this.pageIndexMap.get(e),o=null==a?void 0:a.getSentences()[t];if(o&&o.finished&&""===o.text.text){null===(i=this._onTimeupdate)||void 0===i||i.call(this,e+1,0);return}var l=null==a?void 0:a.getChunk(t);if(l&&!l.data){(0,d.y)("触发限流",{variant:"warning",autoHideDuration:1e3});var p=this.pageIndexMap.get(e);if(this.currentSentenceId<p.getSentencesLength()-1)this.currentSentenceId++;else if(this.audioPlayer.currentTime>0){var g=p.getIndex()+1;this._onTimeupdate(g,this.audioPlayer.currentTime),g<this.pageIndexMap.size&&(this.gotoPage(g),this.currentSentenceId=0)}this.lastPausedTime=0,this.continue(!0);return}l?(new Date().getTime()-this.startLoadDataTime>5e3&&(0,c.dW)("wait-tts-time-too-long",{startTime:this.startLoadDataTime,time:new Date().getTime()-this.startLoadDataTime,text:l.sentence,taskId:this.currentTaskId}),t===a.getSentencesLength()-1&&this.pageIndexMap.has(a.getIndex()+1)&&this.play(this.pageIndexMap.get(a.getIndex()+1).getId(),0),!this.isPaused&&(l.duration<=n&&(n=l.duration-.5<0?0:l.duration-.5),this.audioPlayer.onloadedmetadata=function(){r.audioPlayer.playbackRate=r.speed,r.audioPlayer.currentTime=n,r.audioPlayer.play().catch(function(e){r.isPaused=!0})},this.audioPlayer.src=URL.createObjectURL(new Blob([this.pageIndexMap.get(e).getBuffer(t)],{type:"audio/mp3"})),this.pptId&&u.LM.getState().login&&(0,h.fpm)(this.pptId,null===(s=this.pageIndexMap.get(this.currentPageIndex))||void 0===s?void 0:s.getIndex(),this.currentSentenceId))):this.waitDataTimeout=setTimeout(function(){r.waitData(e,t,n)},100)},t.loadData=function(e,t,n){this.currentPageIndex=e,this.currentSentenceId=t,this.play("",t),clearTimeout(this.waitDataTimeout),this.startLoadDataTime=new Date().getTime(),this.waitData(e,t,n)},t.prev=function(){this.pause();var e=!1,t=null===(a=this.pageIndexMap.get(this.currentPageIndex))||void 0===a?void 0:a.getChunk(this.currentSentenceId);if(t){var n=this.audioPlayer.currentTime-15;if(n<0){var i=this.pageIndexMap.get(this.currentPageIndex).getIndex();if(this.currentSentenceId>0?this.currentSentenceId--:i>0&&(i-=1,this.currentSentenceId=((null===(h=this.pageIndexMap.get(i))||void 0===h?void 0:h.getSentences().length)||0)-1),i>0||this.currentSentenceId>0){for(var s=!1,r=i;r>=0;r--){for(var a,h,d,u=this.pageIndexMap.get(r),c=this.currentSentenceId;c>=0;c--){var o=u.getChunk(c),l=o?o.duration:u.getSendSentence(c).text.text.length/3.7;if(l+n>0){this.gotoPage(r),e=!0,this.currentSentenceId=c,s=!0,this.lastPausedTime=l+n;break}n+=l}if(s)break;this.currentSentenceId=((null===(d=this.pageIndexMap.get(r-1))||void 0===d?void 0:d.getSentences().length)||0)-1}s||(this.gotoPage(0),e=!0,this.currentSentenceId=0,this.lastPausedTime=0)}else this.lastPausedTime=0,e=!0}else this.audioPlayer.currentTime=this.audioPlayer.currentTime-15}this.continue(e||!t)},t.next=function(){var e=!1;this.pause();var t=null===(i=this.pageIndexMap.get(this.currentPageIndex))||void 0===i?void 0:i.getChunk(this.currentSentenceId);if(t){var n=this.audioPlayer.currentTime+30;if(n>t.duration){n-=t.duration;var i,s,r,a=this.pageIndexMap.get(this.currentPageIndex),h=a.getIndex();if(this.currentSentenceId<a.getSentencesLength()-1?this.currentSentenceId++:h<this.pageIndexMap.size&&(h+=1,this.currentSentenceId=0),h<this.pageIndexMap.size-1||this.currentSentenceId<a.getSentencesLength()-1){for(var d,u,c=!1,o=h;o<this.pageIndexMap.size;o++){for(var l=this.pageIndexMap.get(o),p=this.currentSentenceId;p<l.getSentencesLength();p++){var g=l.getChunk(p),x=g?g.duration:l.getSendSentence(p).text.text.length/3.7;if(n<x){if(this.gotoPage(o),e=!0,x-n<2)n=0;else{this.currentSentenceId=p,c=!0,this.lastPausedTime=n;break}}else n-=x}if(c)break;this.currentSentenceId=0}c||(this.gotoPage(this.pageIndexMap.size-1),e=!0,this.currentSentenceId=this.pageIndexMap.get(this.pageIndexMap.size-1).getSentencesLength()-1,this.lastPausedTime=(null===(u=this.pageIndexMap.get(this.pageIndexMap.size-1))||void 0===u?void 0:null===(d=u.getChunk(this.currentSentenceId))||void 0===d?void 0:d.duration)||999999)}else e=!0,this.lastPausedTime=null===(r=this.pageIndexMap.get(this.pageIndexMap.size-1))||void 0===r?void 0:null===(s=r.getChunk(this.currentSentenceId))||void 0===s?void 0:s.duration}else this.audioPlayer.currentTime=this.audioPlayer.currentTime+30}this.continue(e||!t)},t.gotoPage=function(e,t){var n,i=this;this.lastPausedTime=0,t||(this.currentSentenceId=(null===(n=this.pageIndexMap.get(e))||void 0===n?void 0:n.getLastSentenceIndex())||0),this.currentPageIndex=e,clearInterval(this.sendTextInterval),this.sendTextInterval=setInterval(function(){if(i._isConnected)for(var t=e;t<=e+1;t++){var n=i.pageIndexMap.get(t);if(n){var s=n.getSentences(),r=!0,a=!1,h=void 0;try{for(var d,u=s[Symbol.iterator]();!(r=(d=u.next()).done);r=!0){var c=d.value;c.sent||(c.sent=!0,i.send(n.getId(),n.getIndex(),c.text,c.index))}}catch(e){a=!0,h=e}finally{try{r||null==u.return||u.return()}finally{if(a)throw h}}}}else clearInterval(i.sendTextInterval)},500)},t.gotoSentence=function(e){if(e<0){this.currentPageIndex=0;return}var t=this.pageIndexMap.get(this.currentPageIndex);t&&t.getSentences().length>e?this.currentSentenceId=e:t&&(this.currentPageIndex=t.getSentences().length-1)},t.play=function(e,t){var n,i,s,r={action:"play",pageId:e||(null===(n=this.pageIndexMap.get(this.currentPageIndex))||void 0===n?void 0:n.getId()),pageIndex:this.currentPageIndex,taskId:this.currentTaskId,current_playing_index:t};(null===(i=this.ws)||void 0===i?void 0:i.readyState)===WebSocket.OPEN&&(null===(s=this.ws)||void 0===s||s.send(JSON.stringify(r)))},t.setVolume=function(e){this.audioPlayer.volume=e,this.systemAudioPlayer.volume=e,this.volume=e},t.setMute=function(e){this.audioPlayer.volume=e?0:this.volume,this.systemAudioPlayer.volume=e?0:this.volume,this.mute=e},t.setSpeed=function(e){this.audioPlayer.playbackRate=e,this.speed=e},t.getCurrentTime=function(){return this.audioPlayer.currentTime},t.finished=function(){var e={taskId:this.currentTaskId,pageId:"done",action:"normal",text:""};this.ws.send(JSON.stringify(e))},t.toEnd=function(){var e;this.lastPausedTime=0,this.currentSentenceId=null===(e=this.pageIndexMap.get(this.currentPageIndex))||void 0===e?void 0:e.getSentencesLength()},t.getCurrentSentenceIndex=function(){return this.currentSentenceId},t.isPlaying=function(){return!this.isPaused},t.isClosed=function(){return this.closed},t.getPosition=function(){var e;return{pageIndex:(null===(e=this.pageIndexMap.get(this.currentPageIndex))||void 0===e?void 0:e.getIndex())||0,sentenceIndex:this.currentSentenceId}},t.checkLoading=function(){var e;return(null===(e=this.pageIndexMap.get(this.currentPageIndex))||void 0===e?void 0:e.getChunk(this.currentSentenceId))==null},t.disConnect=function(){var e;null===(e=this.ws)||void 0===e||e.close(1e3)},e}()}}]);