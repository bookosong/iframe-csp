(function(e,t){typeof exports=="object"&&typeof module<"u"?t(exports):typeof define=="function"&&define.amd?define(["exports"],t):(e=typeof globalThis<"u"?globalThis:e||self,t(e.Usermaven={}))})(this,function(e){"use strict";var r=(e=>(e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e))(r||{});class se{constructor(e){this.level=e}debug(e,...t){this.level<=0&&console.debug("[Usermaven Debug]:",e,...t)}info(e,...t){this.level<=1&&console.info("[Usermaven Info]:",e,...t)}warn(e,...t){this.level<=2&&console.warn("[Usermaven Warning]:",e,...t)}error(e,...t){this.level<=3&&console.error("[Usermaven Error]:",e,...t)}}function n(e=0){return new se(e)}const T={logLevel:r.ERROR,useBeaconApi:!1,forceUseFetch:!1,trackingHost:"t.usermaven.com",autocapture:!1,rageClick:!1,formTracking:!1,autoPageview:!1,disableEventPersistence:!1,gaHook:!1,segmentHook:!1,randomizeUrl:!1,capture3rdPartyCookies:["_ga","_fbp","_ym_uid","ajs_user_id","ajs_anonymous_id"],idMethod:"cookie",ipPolicy:"keep",cookiePolicy:"keep",minSendTimeout:0,maxSendTimeout:2e3,maxSendAttempts:4,propertiesStringMaxLength:null,propertyBlacklist:[],crossDomainLinking:!0,maskAllText:!1,maskAllElementAttributes:!1};class re{constructor(e){this.domain=e,this.cookieDomain=this.getCookieDomain()}set(e,t,n=365,s=!0,o=!1){const i=new Date;i.setTime(i.getTime()+n*24*60*60*1e3);const a=`expires=${i.toUTCString()}`,r=s?"; Secure":"",c=o?"; HttpOnly":"";document.cookie=`${e}=${t};${a};path=/;domain=${this.cookieDomain}${r}${c}`}get(e){const t=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){let s=n[e].trim();if(s.indexOf(t)===0)return decodeURIComponent(s.substring(t.length))}return null}delete(e,t="/"){document.cookie=`${e}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=${t};domain=${this.cookieDomain}`}getCookieDomain(){return typeof window>"u"||this.domain?this.domain||"":this.extractRoot(window.location.hostname)}extractRoot(e){if(this.isIpAddress(e)||e==="localhost")return e;let t=this.extractTopLevelDomain(e);return t||(t=this.extractRootDomain(e)),"."+t}isIpAddress(e){const t=e.split(".");return t.length===4&&t.every(e=>!isNaN(Number(e)))}extractHostname(e){let t;return e.indexOf("//")>-1?t=e.split("/")[2]:t=e.split("/")[0],t=t.split(":")[0],t=t.split("?")[0],t}extractRootDomain(e){let s=this.extractHostname(e);const t=s.split("."),n=t.length;return n>2&&(t[n-1].length==2?(s=t[n-2]+"."+t[n-1],t[n-2].length==2&&(s=t[n-3]+"."+s)):s=t[n-2]+"."+t[n-1]),s}extractTopLevelDomain(e){const n=/[a-z0-9][a-z0-9-]+\.[a-z.]{2,6}$/i,t=e.match(n);return t?t[0]:""}}const R=Object.prototype.hasOwnProperty,f=Array.prototype.forEach,_={};function B(e,t,n){if(Array.isArray(e))if(f&&e.forEach===f)e.forEach(t,n);else if("length"in e&&e.length===+e.length)for(let s=0,o=e.length;s<o;s++)if(s in e&&t.call(n,e[s],s)===_)return}const j=function(e){return e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},V=function(e){for(const t in e)typeof e[t]=="function"&&(e[t]=e[t].bind(e))};function o(e,t,n){if(e!=null)if(f&&Array.isArray(e)&&e.forEach===f)e.forEach(t,n);else if("length"in e&&e.length===+e.length){for(let s=0,o=e.length;s<o;s++)if(s in e&&t.call(n,e[s],s)===_)return}else for(const s in e)if(R.call(e,s)&&t.call(n,e[s],s)===_)return}const X=function(e,...t){return B(t,function(t){for(const n in t)t[n]!==void 0&&(e[n]=t[n])}),e};function d(e,t){return e.indexOf(t)!==-1}const Z=function(e){try{return/^\s*\bfunction\b/.test(e)}catch{return!1}},ee=function(e){return e===void 0},a=function(){const t=function(e,t,o,i,a){if(!e){n().error("No valid element provided to register_event");return}if(e.addEventListener&&!i)e.addEventListener(t,o,!!a);else{const n="on"+t,i=e[n];e[n]=s(e,o,i)}};function s(t,n,s){return function(o){if(o=o||e(window.event),!o)return;let i=!0,a;Z(s)&&(a=s(o));const r=n.call(t,o);return(a===!1||r===!1)&&(i=!1),i}}function e(t){return t&&(t.preventDefault=e.preventDefault,t.stopPropagation=e.stopPropagation),t}return e.preventDefault=function(){this.returnValue=!1},e.stopPropagation=function(){this.cancelBubble=!0},t}(),oe=function(e){return function(...t){try{return e.apply(this,t)}catch(e){n().error("Implementation error. Please turn on debug and contact support@usermaven.com.",e)}}},x=function(e){for(const t in e)typeof e[t]=="function"&&(e[t]=oe(e[t]))};function z(e){for(let t in e)(e[t]===""||e[t]===null||e[t]===void 0||typeof e[t]=="object"&&Object.keys(e[t]).length===0)&&delete e[t];return e}function t(){try{return typeof window<"u"&&window.document!==void 0&&window.document.createElement!==void 0}catch{return n().warn("window is not available"),!1}}function i(e=5){const t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(36).padStart(2,"0")).join("").slice(0,e)}function ie(e){return e.replace(/([-_][a-z])/g,e=>e.toUpperCase().replace("-","").replace("_",""))}function v(e){return typeof e!="object"||e===null?e:Array.isArray(e)?e.map(v):Object.keys(e).reduce((t,n)=>{const s=ie(n);return t[s]=v(e[n]),t},{})}function m(e){switch(typeof e.className){case"string":return e.className;case"object":return("baseVal"in e.className?e.className.baseVal:null)||e.getAttribute("class")||"";default:return""}}function E(e){let t="";return y(e)&&!D(e)&&e.childNodes&&e.childNodes.length&&o(e.childNodes,function(e){S(e)&&e.textContent&&(t+=j(e.textContent).split(/(\s+)/).filter(u).join("").replace(/[\r\n]/g," ").replace(/[ ]+/g," ").substring(0,255))}),j(t)}function k(e){return!!e&&e.nodeType===1}function s(e,t){return!!e&&!!e.tagName&&e.tagName.toLowerCase()===t.toLowerCase()}function S(e){return!!e&&e.nodeType===3}function g(e){return!!e&&e.nodeType===11}const h=["a","button","form","input","select","textarea","label"];function K(e,t){if(!e||s(e,"html")||!k(e))return!1;let n=e;for(;n&&!s(n,"body");){if(n.classList&&n.classList.contains("um-no-capture"))return!1;n.parentNode&&g(n.parentNode)?n=n.parentNode.host:n=n.parentNode}let o=!1;for(n=e;n&&!s(n,"body");){if(n.parentNode&&g(n.parentNode)){n=n.parentNode.host,n&&h.indexOf(n.tagName.toLowerCase())>-1&&(o=!0);continue}const t=n.parentNode;if(!t)break;if(h.indexOf(t.tagName.toLowerCase())>-1)o=!0;else{const e=window.getComputedStyle(t);e&&e.getPropertyValue("cursor")==="pointer"&&(o=!0)}n=t}const i=window.getComputedStyle(e);if(i&&i.getPropertyValue("cursor")==="pointer"&&t.type==="click")return!0;const a=e.tagName.toLowerCase();switch(a){case"html":return!1;case"form":return t.type==="submit";case"input":return t.type==="change"||t.type==="click";case"select":case"textarea":return t.type==="change"||t.type==="click";default:return o?t.type==="click":t.type==="click"&&(h.indexOf(a)>-1||e.getAttribute("contenteditable")==="true")}}function y(e){for(let t=e;t.parentNode&&!s(t,"body");t=t.parentNode){const n=m(t).split(" ");if(d(n,"ph-sensitive")||d(n,"ph-no-capture"))return!1}if(d(m(e).split(" "),"ph-include"))return!0;const t=e.type||"";if(typeof t=="string")switch(t.toLowerCase()){case"hidden":return!1;case"password":return!1}const n=e.name||e.id||"";return typeof n!="string"||!/^cc|cardnum|ccnum|creditcard|csc|cvc|cvv|exp|pass|pwd|routing|seccode|securitycode|securitynum|socialsec|socsec|ssn/i.test(n.replace(/[^a-zA-Z0-9]/g,""))}function D(e){const t=["button","checkbox","submit","reset"];return!!(s(e,"input")&&!t.includes(e.type)||s(e,"select")||s(e,"textarea")||e.getAttribute("contenteditable")==="true")}function u(e){return!(e===null||ee(e)||typeof e=="string"&&(e=j(e),/^(?:(4[0-9]{12}(?:[0-9]{3})?)|(5[1-5][0-9]{14})|(6(?:011|5[0-9]{2})[0-9]{12})|(3[47][0-9]{13})|(3(?:0[0-5]|[68][0-9])[0-9]{11})|((?:2131|1800|35[0-9]{3})[0-9]{11}))$/.test((e||"").replace(/[- ]/g,""))||/(^\d{3}-?\d{2}-?\d{4}$)/.test(e)))}function L(e){return typeof e=="string"&&(e.substring(0,10)==="_ngcontent"||e.substring(0,7)==="_nghost")}function p(){return i(10)}function P(e){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}function H(e,t){let n;return function(...s){const o=()=>{clearTimeout(n),e(...s)};clearTimeout(n),n=setTimeout(o,t)}}function I(e){const t={},n=e.replace(/^\?/,"").split("&");for(let e=0;e<n.length;e++){const s=n[e].split("=");s[0]!==""&&(t[decodeURIComponent(s[0])]=decodeURIComponent(s[1]||""))}return t}function w(e){return typeof e=="string"||e instanceof String}function l(e){return e!==null&&typeof e=="object"&&e.constructor===Object}function $(e){if(e===null)return r.ERROR;const n=e.toUpperCase(),t=r[n];return t||t===0?t:r.ERROR}const W=()=>{let e="false";return typeof window<"u"&&window.localStorage&&(e=localStorage.getItem("um_exclusion")),e!=null&&e!=="false"};class U{constructor(e){this.maxScrollDepth=0,this.milestones=[25,50,75,90],this.lastScrollDepth=0,this.client=e,this.documentElement=document.documentElement,this.debouncedHandleScroll=H(this.handleScroll.bind(this),250),this.initializeEventListener()}initializeEventListener(){window.addEventListener("scroll",this.debouncedHandleScroll)}track(){const e=this.getScrollDepth();e>this.lastScrollDepth&&(this.lastScrollDepth=e,this.checkMilestones(e))}send(e="$scroll"){if(!this.lastScrollDepth)return;const t={percent:this.lastScrollDepth,window_height:this.getWindowHeight(),document_height:this.getDocumentHeight(),scroll_distance:this.getScrollDistance()};this.client.track(e,t)}handleScroll(){this.track()}getScrollDepth(){const e=this.getWindowHeight(),t=this.getDocumentHeight(),n=this.getScrollDistance(),s=t-e;return Math.min(100,Math.floor(n/s*100))}getWindowHeight(){return window.innerHeight||this.documentElement.clientHeight||document.body.clientHeight||0}getDocumentHeight(){return Math.max(document.body.scrollHeight||0,this.documentElement.scrollHeight||0,document.body.offsetHeight||0,this.documentElement.offsetHeight||0,document.body.clientHeight||0,this.documentElement.clientHeight||0)}getScrollDistance(){return window.pageYOffset||this.documentElement.scrollTop||document.body.scrollTop||0}checkMilestones(e){this.milestones.filter(t=>e>=t).forEach(e=>{this.send(),this.milestones=this.milestones.filter(t=>t!==e)})}}const b=class T{constructor(e,t,s=n()){this.logger=s,this.scrollDepth=null,this.customProperties=[],this.client=e,this.options=t,this.scrollDepth=new U(e),V(this),x(this)}init(){if(!document||!document.body){this.logger.debug("Document not ready yet, trying again in 500 milliseconds..."),setTimeout(()=>this.init(),500);return}this.addDomEventHandlers()}addDomEventHandlers(){const e=e=>{e=e||window.event,this.captureEvent(e)};a(document,"submit",e,!1,!0),a(document,"change",e,!1,!0),a(document,"click",e,!1,!0),a(document,"visibilitychange",e,!1,!0),a(document,"scroll",e,!1,!0),a(window,"popstate",e,!1,!0)}isPageRefresh(){if("PerformanceNavigationTiming"in window){const e=performance.getEntriesByType("navigation");if(e.length>0)return e[0].type==="reload"}return performance.navigation&&performance.navigation.type===1}captureEvent(e){let t=this.getEventTarget(e);if(S(t)&&(t=t.parentNode||null),e.type==="scroll")return(n=this.scrollDepth)==null||n.track(),!0;if(e.type==="visibilitychange"&&document.visibilityState==="hidden"||e.type==="popstate")return this.isPageRefresh()||(i=this.scrollDepth)==null||i.send(),!0;if(t&&K(t,e)){const c=[t];let a=t;for(var n,i;a.parentNode&&!s(a,"body");){if(g(a.parentNode)){c.push(a.parentNode.host),a=a.parentNode.host;continue}c.push(a.parentNode),a=a.parentNode}const l=[];let r,h=!1;if(o(c,e=>{const t=y(e);e.tagName.toLowerCase()==="a"&&(r=e.getAttribute("href"),r=t&&u(r)&&r);const n=m(e).split(" ");d(n,"ph-no-capture")&&(h=!0),l.push(this.getPropertiesFromElement(e,this.options.maskAllElementAttributes??!1,this.options.maskAllText??!1))}),this.options.maskAllText||(l[0].$el_text=E(t)),r&&(l[0].attr__href=r),h)return!1;const f=X(this.getDefaultProperties(e.type),{$elements:l},this.getCustomProperties(c));return this.client.track("$autocapture",f),!0}}getCustomProperties(e){const t={};return o(this.customProperties,n=>{o(n.event_selectors,s=>{const i=document.querySelectorAll(s);o(i,s=>{d(e,s)&&y(s)&&(t[n.name]=this.extractCustomPropertyValue(n))})})}),t}extractCustomPropertyValue(e){const t=[];return o(document.querySelectorAll(e.css_selector),function(e){let n;["input","select"].indexOf(e.tagName.toLowerCase())>-1?n=e.value:e.textContent&&(n=e.textContent),u(n)&&t.push(n)}),t.join(", ")}getEventTarget(e){var t;return typeof e.target>"u"?e.srcElement||null:(t=e.target)!=null&&t.shadowRoot?e.composedPath()[0]||null:e.target||null}getPropertiesFromElement(e,t,n){const a=e.tagName.toLowerCase(),s={tag_name:a};h.indexOf(a)>-1&&!n&&(s.$el_text=E(e));const r=m(e);r.length>0&&(s.classes=r.split(" ").filter(function(e){return e!==""})),o(e.attributes,function(n){D(e)&&["name","id","class"].indexOf(n.name)===-1||!t&&u(n.value)&&!L(n.name)&&(s["attr__"+n.name]=n.value)});let c=1,l=1,i=e;for(;i=this.previousElementSibling(i);)c++,i.tagName===e.tagName&&l++;return s.nth_child=c,s.nth_of_type=l,s}previousElementSibling(e){if(e.previousElementSibling)return e.previousElementSibling;{let t=e;do t=t.previousSibling;while(t&&!k(t))return t}}getDefaultProperties(e){return{$event_type:e,$ce_version:1}}encodeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}static enabledForProject(e,t=10,n=10){if(!e)return!1;let s=0;for(let t=0;t<e.length;t++)s+=e.charCodeAt(t);return s%t<n}};b.FORCE_CAPTURE_ATTR="data-um-force-capture",b.PREVENT_CAPTURE_ATTR="data-um-no-capture";let N=b;class Y{constructor(e){this.client=e,this.lastPageUrl=window.location.href,this.trackInitialPageview(),this.initializePageviewTracking()}trackInitialPageview(){this.trackPageview()}initializePageviewTracking(){window.addEventListener("popstate",this.handlePageview.bind(this));const e=history.pushState;history.pushState=(...t)=>{e.apply(history,t),this.handlePageview()},window.addEventListener("hashchange",this.handlePageview.bind(this)),setInterval(this.checkForUrlChange.bind(this),1e3)}handlePageview(){this.trackPageview()}checkForUrlChange(){window.location.href!==this.lastPageUrl&&this.trackPageview()}trackPageview(){const e=window.location.href;e!==this.lastPageUrl&&(this.lastPageUrl=e,this.client.track("pageview",{url:e,referrer:document.referrer,title:document.title}))}}class G{constructor(e,t,s=n()){this.trackingHost=e,this.logger=s,this.config=t}async send(e){const t=this.config.key,n=this.constructUrl(t),s=new Blob([JSON.stringify(e)],{type:"application/json"});if(navigator.sendBeacon(n,s))this.logger.debug(`Successfully queued ${e.length} event(s) via Beacon API`);else throw new Error("Failed to queue events via Beacon API")}constructUrl(e){const n=this.config.cookiePolicy!=="keep"?`&cookie_policy=${this.config.cookiePolicy}`:"",s=this.config.ipPolicy!=="keep"?`&ip_policy=${this.config.ipPolicy}`:"",o=t()?"/api/v1/event":"/api/v1/s2s/event";return this.config.randomizeUrl?`${this.trackingHost}/api.${i()}?p_${i()}=${e}${n}${s}`:`${this.trackingHost}${o}?token=${e}${n}${s}`}}class F{constructor(e,t,s=n()){this.trackingHost=e,this.logger=s,this.config=t}async send(e){const n=this.config.key,s=this.constructUrl(n),o=JSON.stringify(e),i={"Content-Type":"application/json",...this.getCustomHeaders()},t=await fetch(s,{method:"POST",headers:i,body:o});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);this.logger.debug(`Successfully sent ${e.length} event(s)`),this.postHandle(t.status,await t.text())}constructUrl(e){const n=this.config.cookiePolicy!=="keep"?`&cookie_policy=${this.config.cookiePolicy}`:"",s=this.config.ipPolicy!=="keep"?`&ip_policy=${this.config.ipPolicy}`:"",o=t()?"/api/v1/event":"/api/v1/s2s/event";return this.config.randomizeUrl?`${this.trackingHost}/api.${i()}?p_${i()}=${e}${n}${s}`:`${this.trackingHost}${o}?token=${e}${n}${s}`}getCustomHeaders(){return typeof this.config.customHeaders=="function"?this.config.customHeaders():this.config.customHeaders?this.config.customHeaders:{}}postHandle(e,t){this.logger.debug(`Response received. Status: ${e}, Body: ${t}`)}}class Q{constructor(e,t,s=n()){this.trackingHost=e,this.logger=s,this.config=t}send(e){return new Promise((t,n)=>{const s=new XMLHttpRequest,i=this.config.key,a=this.constructUrl(i);s.open("POST",a,!0),s.setRequestHeader("Content-Type","application/json");const o=this.getCustomHeaders();Object.keys(o).forEach(e=>{s.setRequestHeader(e,o[e])}),s.onload=()=>{s.status>=200&&s.status<300?(this.logger.debug(`Successfully sent ${e.length} event(s)`),t()):n(new Error(`HTTP error! status: ${s.status}`))},s.onerror=()=>{n(new Error("Network error"))},s.send(JSON.stringify(e))})}constructUrl(e){const n=this.config.cookiePolicy!=="keep"?`&cookie_policy=${this.config.cookiePolicy}`:"",s=this.config.ipPolicy!=="keep"?`&ip_policy=${this.config.ipPolicy}`:"",o=t()?"/api/v1/event":"/api/v1/s2s/event";return this.config.randomizeUrl?`${this.trackingHost}/api.${i()}?p_${i()}=${e}${n}${s}`:`${this.trackingHost}${o}?token=${e}${n}${s}`}getCustomHeaders(){return typeof this.config.customHeaders=="function"?this.config.customHeaders():this.config.customHeaders?this.config.customHeaders:{}}postHandle(e,t){this.logger.debug(`Response received. Status: ${e}, Body: ${t}`)}}class M{constructor(e,t){this.storage={},this.prefix=`usermaven_${e}_`,this.load(),this.logger=t||n()}set(e,t){this.storage[e]=t,this.save()}get(e){return this.storage[e]}remove(e){delete this.storage[e],this.save()}clear(){this.storage={},this.save()}save(){if(!t()){this.logger.warn("localStorage is not available in this environment");return}try{localStorage.setItem(this.prefix+"data",JSON.stringify(this.storage))}catch(e){this.logger.error("Error saving to localStorage:",e)}}load(){if(!t()){this.logger.warn("localStorage is not available in this environment");return}try{const e=localStorage.getItem(this.prefix+"data");e&&(this.storage=JSON.parse(e))}catch(e){this.logger.error("Error loading from localStorage:",e)}}}class J{constructor(){this.storage={}}set(e,t){this.storage[e]=t}get(e){return this.storage[e]}remove(e){delete this.storage[e]}save(){}clear(){this.storage={}}}class A{constructor(e,s=3,o=1e3,i=10,a=1e3,r=n(),c="default"){this.transport=e,this.maxRetries=s,this.retryInterval=o,this.batchSize=i,this.batchInterval=a,this.logger=r,this.queue=[],this.processing=!1,this.batchTimeoutId=null,this.isOnline=!0,this.persistence=new M(`offline_queue_${c}`),t()&&(this.isOnline=navigator.onLine,this.loadQueueFromStorage(),this.initNetworkListeners(),this.scheduleBatch())}add(e){const n={payload:e,retries:0,timestamp:Date.now()};this.queue.push(n),t()?this.saveQueueToStorage():this.processBatch()}initNetworkListeners(){t()&&(window.addEventListener("online",()=>{this.isOnline=!0,this.processBatch()}),window.addEventListener("offline",()=>{this.isOnline=!1}))}scheduleBatch(){t()&&(this.batchTimeoutId!==null&&clearTimeout(this.batchTimeoutId),this.batchTimeoutId=window.setTimeout(()=>this.processBatch(),this.batchInterval))}async processBatch(){if((!t()||this.isOnline)&&!this.processing&&this.queue.length>0){this.processing=!0;const e=this.queue.splice(0,this.batchSize),n=e.map(e=>e.payload);try{await this.transport.send(n),this.logger.debug(`Successfully sent batch of ${e.length} payloads`),t()&&this.saveQueueToStorage()}catch(t){this.logger.error("Failed to send batch",t),await this.handleBatchFailure(e)}this.processing=!1}t()&&this.scheduleBatch()}async handleBatchFailure(e){for(const t of e)t.retries<this.maxRetries?(t.retries++,this.queue.unshift(t),this.logger.warn(`Retry attempt ${t.retries} for payload`)):this.logger.error("Max retries reached, discarding payload",t.payload);t()&&(this.saveQueueToStorage(),await new Promise(e=>setTimeout(e,this.retryInterval)))}loadQueueFromStorage(){if(t()){const e=this.persistence.get("queue");e&&(this.queue=JSON.parse(e))}}saveQueueToStorage(){t()&&this.persistence.set("queue",JSON.stringify(this.queue))}}class te{constructor(e){this.clicks=[],this.threshold=3,this.timeWindow=2e3,this.distanceThreshold=30,this.client=e,this.initializeEventListener(),x(this)}initializeEventListener(){document.addEventListener("click",this.handleClick.bind(this))}handleClick(e){const t=e.target;this.shouldCaptureElement(t)&&this.click(e.clientX,e.clientY,Date.now())}shouldCaptureElement(e){return!e.closest(".um-no-capture")}click(e,t,n){const s={x:e,y:t,timestamp:n};this.clicks.push(s),this.clicks=this.clicks.filter(e=>n-e.timestamp<this.timeWindow),this.clicks.length>=this.threshold&&this.checkRageClick()}checkRageClick(){const e=this.clicks[0],t=(this.clicks[this.clicks.length-1].timestamp-e.timestamp)/1e3;this.clicks.every((e,t)=>{if(t===0)return!0;const n=this.clicks[t-1];return Math.sqrt(Math.pow(e.x-n.x,2)+Math.pow(e.y-n.y,2))<this.distanceThreshold})&&this.sendRageClickEvent(t)}sendRageClickEvent(e){const t=this.clicks[this.clicks.length-1];document.elementFromPoint(t.x,t.y)&&this.client.track("$rage_click",{no_of_clicks:this.clicks.length,time:e.toFixed(2)}),this.clicks=[]}}class ne{constructor(e,t,s=n()){this.trackingHost=e,this.logger=s,this.config=t}async send(e){const n=this.config.key,t=new(void 0)(this.constructUrl(n)),s={hostname:t.hostname,port:443,path:`${t.pathname}${t.search}`,method:"POST",headers:{"Content-Type":"application/json",...this.getCustomHeaders()}};return new Promise((t,n)=>{const o=(void 0)(s,s=>{s.on("data",e=>{}),s.on("end",()=>{const o=s.statusCode||0;o>=200&&o<300?(this.logger.debug(`Successfully sent ${e.length} event(s)`),t()):n(new Error(`HTTP error! status: ${o}`))})});o.on("error",e=>{n(e)}),o.write(JSON.stringify(e)),o.end()})}constructUrl(e){const t=this.config.cookiePolicy!=="keep"?`&cookie_policy=${this.config.cookiePolicy}`:"",n=this.config.ipPolicy!=="keep"?`&ip_policy=${this.config.ipPolicy}`:"";return`${this.trackingHost}/api/v1/s2s/event?token=${e}${t}${n}`}getCustomHeaders(){return typeof this.config.customHeaders=="function"?this.config.customHeaders():this.config.customHeaders?this.config.customHeaders:{}}}class c{constructor(e,t="all",n={}){this.instance=e,this.trackingType=t,this.options=n,document.readyState==="loading"?document.addEventListener("DOMContentLoaded",this.initialize.bind(this)):this.initialize()}initialize(){this.trackingType!=="none"&&this.setupFormTracking()}setupFormTracking(){var e;this.formElements=this.trackingType==="tagged"?document.querySelectorAll("form[data-um-form]"):document.querySelectorAll("form"),(e=this.formElements)==null||e.forEach(e=>{e.addEventListener("submit",this.handleFormSubmit.bind(this))})}handleFormSubmit(e){const t=e.target,n=this._getFormDetails(t);this.instance.track("$form",z(n)),this.options.trackFieldChanges&&this.trackFieldChanges(t)}trackFieldChanges(e){e.querySelectorAll("input, select, textarea").forEach(e=>{e.addEventListener("change",e=>{const t=this._getFieldProps(e.target,0);this.instance.track("$form_field_change",z(t))})})}static getInstance(e,t="all",n={}){return c.instance||(c.instance=new c(e,t,n)),c.instance}_getFormDetails(e){const t={form_id:e.id,form_name:e.name||"",form_action:e.action,form_method:e.method,form_class:e.className,form_attributes:this._getElementAttributes(e)},n=e.querySelectorAll("input, select, textarea");return Array.from(n).filter(e=>!e.classList.contains("um-no-capture")).forEach((e,n)=>{const s=this._getFieldProps(e,n);Object.assign(t,s)}),t}_getFieldProps(e,t){const n=Object.keys(e.dataset).length?JSON.stringify(e.dataset):void 0,s=this.getSafeText(e);return{[`field_${t+1}_tag`]:e.tagName.toLowerCase(),[`field_${t+1}_type`]:e instanceof HTMLInputElement?e.type:void 0,[`field_${t+1}_data_attributes`]:n,[`field_${t+1}_id`]:e.id,[`field_${t+1}_value`]:s,[`field_${t+1}_class`]:e.className,[`field_${t+1}_name`]:e.name,[`field_${t+1}_attributes`]:this._getElementAttributes(e)}}_getElementAttributes(e){return Object.keys(e.dataset).length?JSON.parse(JSON.stringify(e.dataset)):{}}getSafeText(e){let t="";return"value"in e&&e.type!=="password"?t=e.value:e.hasChildNodes()?t=Array.from(e.childNodes).filter(e=>e.nodeType===Node.TEXT_NODE).map(e=>e.textContent).join(""):t=e.textContent||"",this._scrubPotentiallySensitiveValues(t)}_scrubPotentiallySensitiveValues(e){return this._shouldCaptureValue(e)?e:"<redacted>"}_shouldCaptureValue(e){return!(this._isNullish(e)||this._isString(e)&&(e=this._trim(e),/^(?:(4[0-9]{12}(?:[0-9]{3})?)|(5[1-5][0-9]{14})|(6(?:011|5[0-9]{2})[0-9]{12})|(3[47][0-9]{13})|(3(?:0[0-5]|[68][0-9])[0-9]{11})|((?:2131|1800|35[0-9]{3})[0-9]{11}))$/.test((e||"").replace(/[- ]/g,""))||/(^\d{3}-?\d{2}-?\d{4}$)/.test(e)))}_isNullish(e){return e==null}_isString(e){return typeof e=="string"||e instanceof String}_trim(e){if(typeof String.prototype.trim=="function")return e.trim();let t=0,n=e.length-1;const s=[" ",`
`,``,"	","",""," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," "," ","　"].join("");for(;t<=n&&s.indexOf(e[t])>-1;)t++;for(;n>=t&&s.indexOf(e[n])>-1;)n--;return e.slice(t,n+1)}}class C{constructor(e){this.config=this.mergeConfig(e,T),this.logger=n(this.config.logLevel),this.namespace=e.namespace||"default",this.transport=this.initializeTransport(this.config),this.persistence=this.initializePersistence(),this.retryQueue=new A(this.transport,this.config.maxSendAttempts||3,this.config.minSendTimeout||1e3,10,200,this.logger,this.namespace),t()&&this.initializeBrowserFeatures(),this.anonymousId=this.getOrCreateAnonymousId(),this.logger.info(`Usermaven client initialized for namespace: ${this.namespace}`)}initializeBrowserFeatures(){if(this.cookieManager=new re(this.config.cookieDomain),this.config.autocapture&&N.enabledForProject(this.config.key)&&(this.autoCapture=new N(this,this.config,this.logger),this.autoCapture.init()),this.config.formTracking){const e=this.config.formTracking===!0?"all":this.config.formTracking;this.formTracking=c.getInstance(this,e||"none",{trackFieldChanges:!1})}this.config.autoPageview&&(this.pageviewTracking=new Y(this)),this.config.crossDomainLinking&&this.manageCrossDomainLinking(),this.config.rageClick&&(this.rageClick=new te(this)),this.setupPageLeaveTracking()}mergeConfig(e,t){const s=JSON.parse(JSON.stringify(e));let n={...t,...s};return Object.keys(t).forEach(s=>{l(t[s])&&(n[s]=this.mergeConfig(e[s],t[s]))}),n}init(e){this.config={...this.config,...e},this.logger=n(this.config.logLevel),this.namespace=e.namespace||this.namespace,this.transport=this.initializeTransport(e),this.persistence=this.initializePersistence(),this.retryQueue=new A(this.transport,this.config.maxSendAttempts||3,this.config.minSendTimeout||1e3,10,250,this.logger,this.namespace),t()&&this.initializeBrowserFeatures(),this.anonymousId=this.getOrCreateAnonymousId(),this.logger.info(`Usermaven client reinitialized for namespace: ${this.namespace}`)}manageCrossDomainLinking(){if(!this.config.crossDomainLinking||!this.config.domains)return;const e=this.config.domains.split(",").map(e=>e.trim()),t=this.config.cookieName||`__eventn_id_${this.config.key}`;document.addEventListener("click",n=>{var a;const o=this.findClosestLink(n.target);if(!o)return;const i=o.getAttribute("href");if(!i||!i.startsWith("http"))return;const s=new URL(i);if(s.hostname!==window.location.hostname&&e.includes(s.hostname)){const e=(a=this.cookieManager)==null?void 0:a.get(t);e&&(s.searchParams.append("_um",e),o.setAttribute("href",s.toString()))}}),this.logger.debug("Cross-domain linking initialized")}findClosestLink(e){for(;e&&e.tagName!=="A";)e=e.parentElement;return e}initializeTransport(e){const n="https://events.usermaven.com";if(!t())return new ne(e.trackingHost||n,e);const o="XMLHttpRequest"in window,s=typeof fetch<"u",i=typeof navigator<"u"&&"sendBeacon"in navigator;if(e.useBeaconApi&&i)return new G(e.trackingHost||n,e,this.logger);if(e.forceUseFetch&&s)return new F(e.trackingHost||n,e,this.logger);if(o)return new Q(e.trackingHost||n,e,this.logger);if(s)return new F(e.trackingHost||n,e,this.logger);throw new Error("No suitable transport method available")}initializePersistence(){return this.config.disableEventPersistence||!t()?new J:new M(`${this.namespace}_${this.config.key}`,this.logger)}getOrCreateAnonymousId(){var n,s;if(!t())return p();if(this.config.privacyPolicy==="strict"||this.config.cookiePolicy==="strict")return"";const o=this.config.cookieName||`__eventn_id_${this.config.key}`;let e=(n=this.cookieManager)==null?void 0:n.get(o);if(!e){if(this.config.crossDomainLinking){const n=new URLSearchParams(window.location.search).get("_um"),t=window.location.hash.substring(1).split("~"),s=t.length>1?t[1]:void 0;e=n||s||p()}e||(e=p());const t=365*10;(s=this.cookieManager)==null||s.set(o,e,t,document.location.protocol!=="http:",!1)}return e}async id(e,t=!1){if(!l(e))throw new Error("User data must be an object");if(e.email&&!P(e.email))throw new Error("Invalid email provided");if(!e.id||!w(e.id))throw new Error("User ID must be a string");const n=e.id;if(this.persistence.set("userId",n),this.persistence.set("userProps",e),!t){const t={...e,anonymous_id:this.anonymousId};await this.track("user_identify",t)}this.logger.info("User identified:",e)}track(e,t,n=!1){this.trackInternal(e,t,n)}trackInternal(e,t,n=!1){if(W()){this.logger.debug("Tracking disabled due to um_exclusion setting");return}if(!w(e))throw new Error("Event name must be a string");if(t!==void 0&&(typeof t!="object"||t===null||Array.isArray(t)))throw new Error("Event payload must be a non-null object and not an array");const s=this.createEventPayload(e,t);try{if(n){this.transport.send(s),this.logger.debug(`Event sent: ${e}`,[s]);return}this.retryQueue.add(s),this.logger.debug(`Event tracked: ${e}`,[s])}catch(t){throw this.logger.error(`Failed to track event: ${e}`,t),new Error(`Failed to track event: ${e}`)}}rawTrack(e){if(!l(e))throw new Error("Event payload must be an object");this.track("raw",e)}async group(e,t=!1){if(!l(e))throw new Error("Company properties must be an object");if(!e.id||!e.name||!e.created_at)throw new Error("Company properties must include id, name, and created_at");this.persistence.set("companyProps",e),t||await this.track("group",e),this.logger.info("Company identified:",e)}createEventPayload(e,n){const o=this.persistence.get("userProps")||{},i=this.persistence.get("companyProps")||o?.company||{},r=this.persistence.get("userId"),c=this.persistence.get("global_props")||{},l=this.persistence.get(`props_${e}`)||{};let a=n||{};const s={event_id:"",user:{anonymous_id:this.anonymousId,id:r,...o},...i&&{company:i},ids:this.getThirdPartyIds(),utc_time:(new Date).toISOString(),local_tz_offset:(new Date).getTimezoneOffset(),api_key:this.config.key,src:"usermaven",event_type:e,namespace:this.namespace,...c,...l};if(e==="$autocapture"){const e=this.processAutocaptureAttributes(n||{});s.autocapture_attributes=e}else e!=="user_identify"&&e!=="group"&&(Array.isArray(this.config.propertyBlacklist)&&this.config.propertyBlacklist.forEach(e=>{delete a[e]}),s.event_attributes=a);return t()&&(s.referer=document.referrer,s.url=window.location.href,s.page_title=document.title,s.doc_path=window.location.pathname,s.doc_host=window.location.hostname,s.doc_search=window.location.search,s.screen_resolution=`${window.screen.width}x${window.screen.height}`,s.vp_size=`${window.innerWidth}x${window.innerHeight}`,s.user_agent=navigator.userAgent,s.user_language=navigator.language,s.doc_encoding=document.characterSet,s.utm=this.getUtmParams()),s}processAutocaptureAttributes(e){let t={};const n=e.$elements||[];return n.length&&(t={...n[0]}),t.el_text=t.$el_text||"",t.event_type=e.$event_type||"",["$ce_version","$event_type","$initial_referrer","$initial_referring_domain","$referrer","$referring_domain","$elements"].forEach(e=>{delete t[e]}),delete t.$el_text,delete t.nth_child,delete t.nth_of_type,t}getCookie(e){var t;return((t=this.cookieManager)==null?void 0:t.get(e))||null}getThirdPartyIds(){const e={};if(t()){const t=this.getCookie("_fbp");t&&(e.fbp=t)}return e}getUtmParams(){const e={},t=I(window.location.search);return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(n=>{t[n]&&(e[n.replace("utm_","")]=t[n])}),e}pageview(){t()?this.track("pageview",{url:window.location.href,referrer:document.referrer,title:document.title},!0):this.logger.warn("Pageview tracking is not available in server-side environments")}setupPageLeaveTracking(){if(!t())return;let s=!1,e=!1;const n=()=>{!s&&!e&&(s=!0,this.track("$pageleave",{url:window.location.href,referrer:document.referrer,title:document.title}))};window.addEventListener("beforeunload",t=>{e=!0,setTimeout(()=>{e=!1},100)}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&!e&&n()});const o=history.pushState;history.pushState=function(){return n(),o.apply(this,arguments)},window.addEventListener("popstate",n)}getConfig(){return this.config}getLogger(){return this.logger}async reset(e=!1){if(this.persistence.clear(),e&&this.cookieManager){const e=this.config.cookieName||`__eventn_id_${this.config.key}`;this.cookieManager.delete(e),this.anonymousId=this.getOrCreateAnonymousId()}this.logger.info("core state reset",{resetAnonId:e,namespace:this.namespace})}set(e,t){if(!l(e))throw new Error("Properties must be an object");const n=t?.eventType,s=t?.persist??!0;if(n){let t=this.persistence.get(`props_${n}`)||{};t={...t,...e},this.persistence.set(`props_${n}`,t)}else{let t=this.persistence.get("global_props")||{};t={...t,...e},this.persistence.set("global_props",t)}s&&this.persistence.save(),this.logger.debug("Properties set",{properties:e,eventType:n||"global",persist:s})}setUserId(e){this.persistence.set("userId",e);let t=this.persistence.get("userProps")||{};t.id=e,this.persistence.set("userProps",t),this.persistence.save()}unset(e,t){const n=t?.eventType,s=t?.persist??!0;if(n){let t=this.persistence.get(`props_${n}`)||{};delete t[e],this.persistence.set(`props_${n}`,t)}else{let t=this.persistence.get("global_props")||{};delete t[e],this.persistence.set("global_props",t)}s&&this.persistence.save(),this.logger.debug(`Property unset: ${e}`,`Event type: ${n||"global"}`)}}function O(e){const n=JSON.parse(JSON.stringify(e)),s=v(n),t={...T,...s};if(!t.key)throw new Error("API key is required!");if(!t.trackingHost)throw new Error("Tracking host is required!");return new C(t)}function ae(e){var s;const n={key:e.getAttribute("data-key")||void 0,trackingHost:e.getAttribute("data-tracking-host")||"https://events.usermaven.com",logLevel:$(e.getAttribute("data-log-level")),autocapture:e.getAttribute("data-autocapture")==="true",formTracking:e.getAttribute("data-form-tracking")!=="false"&&(e.getAttribute("data-form-tracking")==="true"?"all":e.getAttribute("data-form-tracking")),autoPageview:e.getAttribute("data-auto-pageview")==="true",useBeaconApi:e.getAttribute("data-use-beacon-api")==="true",forceUseFetch:e.getAttribute("data-force-use-fetch")==="true",gaHook:e.getAttribute("data-ga-hook")==="true",segmentHook:e.getAttribute("data-segment-hook")==="true",randomizeUrl:e.getAttribute("data-randomize-url")==="true",capture3rdPartyCookies:e.getAttribute("data-capture-3rd-party-cookies")!=="false"&&void 0,idMethod:e.getAttribute("data-id-method")||void 0,privacyPolicy:e.getAttribute("data-privacy-policy")==="strict"?"strict":void 0,ipPolicy:e.getAttribute("data-ip-policy")||void 0,cookiePolicy:e.getAttribute("data-cookie-policy")||void 0,minSendTimeout:parseInt(e.getAttribute("data-min-send-timeout")||"",10)||void 0,maxSendTimeout:parseInt(e.getAttribute("data-max-send-timeout")||"",10)||void 0,maxSendAttempts:parseInt(e.getAttribute("data-max-send-attempts")||"",10)||void 0,propertiesStringMaxLength:parseInt(e.getAttribute("data-properties-string-max-length")||"",10)||null,propertyBlacklist:((s=e.getAttribute("data-property-blacklist"))==null?void 0:s.split(","))||void 0,exclude:e.getAttribute("data-exclude")||void 0,namespace:e.getAttribute("data-namespace")||void 0,crossDomainLinking:e.getAttribute("data-cross-domain-linking")!=="false",domains:e.getAttribute("data-domains")||void 0,maskAllText:e.getAttribute("data-mask-all-text")==="true",maskAllElementAttributes:e.getAttribute("data-mask-all-element-attributes")==="true"};n.privacyPolicy==="strict"&&(n.cookiePolicy="strict",n.ipPolicy="strict"),n.cookiePolicy==="comply"&&n.useBeaconApi&&(n.cookiePolicy="strict");const o=O(n),i=n.namespace||"usermaven";t()&&o.pageview(),q(i,o)}function q(e,t){let i=!1;const s=[],o=[];function r(){for(;s.length>0;){const t=s.shift();t&&window[e].apply(null,t)}}function c(){o.forEach(e=>e()),o.length=0}window[e]=function(...e){const n=e[0];if(n==="onLoad"){typeof e[1]=="function"&&(i?e[1]():o.push(e[1]));return}if(!i){s.push(e);return}if(typeof t[n]=="function")return t[n].apply(t,e.slice(1));console.error(`Method ${n} not found on UsermavenClient`)};const a=`${e}Q`,n=window[a]||[];for(window[a]=n,n.push=function(...t){return window[e].apply(null,t),Array.prototype.push.apply(this,t)},setTimeout(()=>{i=!0,r(),c(),console.log(`Usermaven client for namespace ${e} is ready`)},0);n.length>0;){const t=n.shift();t&&s.push(t)}}t()&&function(e,t){const n=e.currentScript;function s(){n&&n.src.includes("lib.js")&&ae(n)}typeof t<"u"&&(e.readyState==="loading"?e.addEventListener("DOMContentLoaded",s):s())}(document,window),e.LogLevel=r,e.UsermavenClient=C,e.usermavenClient=O,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})})